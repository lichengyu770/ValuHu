<!doctype html>
<html lang="zh-CN">
  <head>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>估价引擎 - 数智估价核心引擎 - ValuHub</title>
    <!-- 引入图标库 -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- 引入共享样式 -->
    <link rel="stylesheet" href="shared.css" />
    <!-- 页面特定样式 -->
    <style>
      /* 估价引擎页面特定样式 */
      .valuation-section {
        background: white;
      }

      .valuation-content {
        max-width: 1000px;
        margin: 0 auto;
      }

      .valuation-features {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 30px;
        margin: 40px 0;
      }

      .valuation-feature {
        background: #f5f7fa;
        padding: 30px;
        border-radius: 8px;
        transition:
          transform 0.3s,
          box-shadow 0.3s;
      }

      .valuation-feature:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }

      .valuation-feature i {
        font-size: 36px;
        color: #007aff;
        margin-bottom: 20px;
      }

      .valuation-feature h3 {
        font-size: 18px;
        color: #1d2129;
        margin-bottom: 15px;
      }

      .valuation-feature p {
        font-size: 14px;
        color: #666;
        line-height: 1.6;
      }

      .start-valuation-btn {
        display: inline-block;
        background: linear-gradient(135deg, #007aff, #0056b3);
        color: white;
        padding: 12px 30px;
        border-radius: 25px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s ease;
        margin: 20px 0;
      }

      .start-valuation-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 122, 255, 0.3);
      }
    
        img[src="图片1.png"] {
            max-width: 45px !important;
            max-height: 45px !important;
            width: 45px !important;
            height: 45px !important;
            object-fit: contain !important;
            display: inline-block !important;
        }
    </style>
  








<style>
/* 通用修复样式 - 确保文字横向显示和导航栏增大 */

/* 最高优先级 - 确保所有元素文字横向显示 */
*,
*::before,
*::after {
    writing-mode: horizontal-tb !important;
    text-orientation: mixed !important;
    direction: ltr !important;
    /* 只确保文字横向，不强制flex布局，让文本正常换行 */
}

/* 确保文本元素正常显示空格和换行 */
p,
span,
div,
th,
td,
li,
strong,
em,
ai,
button,
input,
textarea,
select,
label,
h1,
h2,
h3,
h4,
h5,
h6 {
    display: block !important;
    white-space: normal !important;
    word-break: normal !important;
    overflow-wrap: break-word !important;
}

/* 修复LOGO文字竖向显示问题 */
.navbar-brand,
.logo {
    display: flex !important;
    align-items: center !important;
    gap: var(--spacing-2) !important;
    flex-direction: row !important;
    white-space: nowrap !important;
}

.navbar-brand img,
.logo img {
    display: inline-block !important;
    vertical-align: middle !important;
    max-width: 50px !important;
    max-height: 50px !important;
    width: 50px !important;
    height: 50px !important;
    object-fit: contain !important;
}

.navbar-brand span,
.navbar-brand a,
.logo span,
.logo a {
    display: inline-block !important;
    vertical-align: middle !important;
}

/* 确保导航栏和菜单正确显示 */
.navbar {
    height: 80px !important;
    padding: 16px 24px !important;
    min-height: 80px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: space-between !important;
}

/* 导航菜单样式 */
.nav-menu {
    display: flex !important;
    flex-direction: row !important;
    align-items: center !important;
    gap: var(--spacing-4) !important;
}

.nav-menu a {
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    height: 80px !important;
    padding: 0 16px !important;
    font-size: 16px !important;
    line-height: 1 !important;
    text-decoration: none !important;
    color: inherit !important;
    white-space: nowrap !important;
}

/* 导航按钮样式 */
.nav-menu .btn {
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
    height: auto !important;
    min-height: 40px !important;
    padding: 8px 16px !important;
    font-size: 14px !important;
    line-height: 1 !important;
}

/* 确保容器元素横向显示 */
.d-flex,
.align-items-center,
.justify-content-between,
.justify-content-center,
.hero-buttons,
.filter-group,
.filter-search-section,
.action-buttons,
.nav-actions,
.nav-left,
.nav-right,
.user-info,
.stat-header,
.score-item-header {
    display: flex !important;
    flex-direction: row !important;
}

/* 移动端菜单按钮样式 */
.btn-text.d-lg-none {
    display: none !important;
}

/* 确保网格布局正常显示 */
.grid,
.grid-cols-4,
.grid-cols-3,
.grid-cols-2 {
    display: grid !important;
    flex-direction: initial !important;
}

/* 确保表格布局正常显示 */
table,
tr,
thead,
tbody,
th,
td {
    display: table !important;
    display: table-row !important;
    display: table-header-group !important;
    display: table-row-group !important;
    display: table-cell !important;
    flex-direction: initial !important;
}

/* 确保列表布局正常显示 */
ul,
ol,
li {
    display: list-item !important;
    flex-direction: initial !important;
}

/* 确保表单元素正常显示 */
input,
textarea,
select,
button {
    display: inline-block !important;
    flex-direction: initial !important;
}

/* 确保文本内容正常显示换行和空格 */
.text-content,
.card-content,
.main-content,
.scoring-content,
.page-header,
.analysis-title,
.analysis-subtitle,
.chart-container,
.card,
.card-header,
.status-tag,
.score-display,
.pagination,
.pagination-info,
.score-detail-body,
.detail-section,
.detail-title,
.detail-item,
.detail-label,
.detail-value,
.score-item-name,
.score-item-weight,
.score-item-score,
.score-item-description,
.form-group,
.form-label {
    display: block !important;
    flex-direction: initial !important;
    white-space: normal !important;
    word-wrap: break-word !important;
    word-break: normal !important;
}
</style>
</head>
  <body>
    <!-- 统一导航栏CSS -->
    <style>
      /* 导航栏基础样式 */
      .navbar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        background: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        z-index: 1000;
      }

      .navbar .container {
        display: flex;
        align-items: center;
        justify-content: space-between;
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
        height: 65px;
      }

      /* Logo样式 */
      .logo {
        display: flex;
        align-items: center;
        gap: 10px;
        text-decoration: none;
        transition: all 0.3s ease;
      }

      .logo:hover {
        transform: translateY(-1px);
      }

      .logo-icon {
        width: 40px;
        height: 40px;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      .logo-icon:hover {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(26, 115, 232, 0.4);
      }

      .logo-icon img {
        width: 32px;
        height: 32px;
        object-fit: contain;
      }

      .logo-text {
        font-size: 18px;
        font-weight: bold;
        background: linear-gradient(135deg, #1a73e8, #f9a825);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      /* 导航菜单 */
      .nav-menu {
        display: flex;
        align-items: center;
        gap: 20px;
      }

      .nav-menu > a {
        text-decoration: none;
        color: #333;
        font-weight: 500;
        transition: all 0.3s ease;
        padding: 8px 12px;
        border-radius: 6px;
      }

      .nav-menu > a:hover,
      .nav-menu > a.active {
        color: #1a73e8;
        background: rgba(26, 115, 232, 0.1);
      }

      /* 下拉菜单 */
      .dropdown {
        position: relative;
      }

      .dropdown-toggle {
        display: flex;
        align-items: center;
        gap: 5px;
        text-decoration: none;
        color: #333;
        font-weight: 500;
        transition: all 0.3s ease;
        padding: 8px 12px;
        border-radius: 6px;
      }

      .dropdown-toggle:hover {
        color: #1a73e8;
        background: rgba(26, 115, 232, 0.1);
      }

      .dropdown-menu {
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        border-radius: 8px;
        padding: 8px 0;
        min-width: 180px;
        z-index: 1001;
        opacity: 0;
        visibility: hidden;
        transform: translateY(-10px);
        transition: all 0.3s ease;
      }

      .dropdown:hover .dropdown-menu {
        opacity: 1;
        visibility: visible;
        transform: translateY(0);
      }

      .dropdown-item {
        display: block;
        padding: 10px 16px;
        text-decoration: none;
        color: #333;
        font-size: 14px;
        transition: all 0.3s ease;
      }

      .dropdown-item:hover {
        background: rgba(26, 115, 232, 0.1);
        color: #1a73e8;
      }

      /* 登录按钮 */
      .btn {
        padding: 8px 20px;
        border: none;
        border-radius: 6px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        text-decoration: none;
        display: inline-block;
      }

      .btn-primary {
        background: linear-gradient(135deg, #1a73e8, #0d47a1);
        color: white;
      }

      .btn-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 15px rgba(26, 115, 232, 0.4);
      }

      /* 移动端菜单按钮 */
      .menu-toggle {
        display: none;
        background: none;
        border: none;
        font-size: 20px;
        color: #333;
        cursor: pointer;
        padding: 8px;
      }

      /* 移动端菜单 */
      .mobile-menu {
        display: none;
        position: fixed;
        top: 65px;
        left: 0;
        right: 0;
        background: white;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        z-index: 999;
        max-height: calc(100vh - 65px);
        overflow-y: auto;
      }

      .mobile-menu ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .mobile-menu li {
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
      }

      .mobile-menu a {
        display: block;
        padding: 15px 20px;
        text-decoration: none;
        color: #333;
        font-weight: 500;
        transition: all 0.3s ease;
      }

      .mobile-menu a:hover,
      .mobile-menu a.active {
        background: rgba(26, 115, 232, 0.1);
        color: #1a73e8;
      }

      /* 响应式设计 */
      @media (max-width: 992px) {
        .nav-menu {
          display: none;
        }

        .menu-toggle {
          display: block;
        }

        .mobile-menu {
          display: block;
        }
      }

      /* 页面内容间距 */
      body {
        margin-top: 65px;
      }
    </style>

    <!-- 1. 导航栏（统一模板） -->
    <nav class="navbar">
      <div class="container">
        <a href="index.html" class="logo">
          <div class="logo-icon">
            <img
              src="src/assets/images/logo.svg"
              alt="系统Logo"
              width="32"
              height="32"
              style="object-fit: contain"
            />
          </div>
          <span class="logo-text">数智估价核心引擎</span>
        </a>
        <div class="nav-menu">
          <a href="index.html" class="">首页</a>
          <!-- 产品服务下拉菜单 -->
          <div class="dropdown">
            <a href="#" class="dropdown-toggle"
              >产品服务 <i class="fas fa-chevron-down"></i
            ></a>
            <div class="dropdown-menu">
              <a href="valuation-engine.html" class="">估价引擎</a>
              <a href="advanced-search.html" class="">高级搜索</a>
              <a href="product-services.html" class="">产品服务</a>
            </div>
          </div>
          <!-- 用户中心 -->
          <a href="user-center.html" class="">用户中心</a>
          <!-- 数据分析下拉菜单 -->
          <div class="dropdown">
            <a href="#" class="dropdown-toggle"
              >数据分析 <i class="fas fa-chevron-down"></i
            ></a>
            <div class="dropdown-menu">
              <a href="market-analysis.html" class="">市场分析</a>
              <a href="comparison-tool.html" class="">比较工具</a>
              <a href="data-visualization.html" class="">数据可视化</a>
              <a href="case-study.html" class="">客户案例</a>
            </div>
          </div>
          <!-- 评估预览下拉菜单 -->
          <div class="dropdown">
            <a href="#" class="dropdown-toggle"
              >评估预览 <i class="fas fa-chevron-down"></i
            ></a>
            <div class="dropdown-menu">
              <a href="gis-evaluation-preview.html" class="">GIS评估预览</a>
              <a href="revenue-evaluation-preview.html" class=""
                >收益评估预览</a
              >
            </div>
          </div>
          <!-- 关于我们下拉菜单 -->
          <div class="dropdown">
            <a href="#" class="dropdown-toggle"
              >关于我们 <i class="fas fa-chevron-down"></i
            ></a>
            <div class="dropdown-menu">
              <a href="tech-frame.html" class="">技术框架</a>
              <a href="api-docs.html" class="">API文档</a>
              <a href="team-intro.html" class="">团队介绍</a>
              <a href="about-us.html" class="">关于我们</a>
            </div>
          </div>
          <!-- 登录按钮 -->
          <button class="btn btn-primary" id="loginBtn">登录</button>
        </div>
        <div class="menu-toggle" id="menuToggle">
          <i class="fas fa-bars"></i>
        </div>
      </div>
    </nav>

    <!-- 移动端菜单 -->
    <div class="mobile-menu" id="mobileMenu">
      <ul>
        <li><a href="index.html" class="">首页</a></li>
        <li><a href="valuation-engine.html">估价引擎</a></li>
        <li><a href="advanced-search.html">高级搜索</a></li>
        <li><a href="user-center.html">用户中心</a></li>
        <li><a href="market-analysis.html">市场分析</a></li>
        <li><a href="comparison-tool.html">比较工具</a></li>
        <li><a href="data-visualization.html">数据可视化</a></li>
        <li><a href="case-study.html">客户案例</a></li>
        <li><a href="product-services.html">产品服务</a></li>
        <li><a href="gis-evaluation-preview.html">GIS评估预览</a></li>
        <li><a href="revenue-evaluation-preview.html">收益评估预览</a></li>
        <li><a href="tech-frame.html">技术框架</a></li>
        <li><a href="api-docs.html">API文档</a></li>
        <li><a href="team-intro.html">团队介绍</a></li>
        <li><a href="about-us.html">关于我们</a></li>
        <li><a href="contact.html">联系方式</a></li>
        <li><a href="help-center.html">帮助中心</a></li>
      </ul>
    </div>

    <!-- 导航栏JavaScript -->
    <script>
      // 移动端菜单切换
      document
        .getElementById('menuToggle')
        .addEventListener('click', function () {
          const mobileMenu = document.getElementById('mobileMenu');
          mobileMenu.style.display =
            mobileMenu.style.display === 'none' ? 'block' : 'none';
        });

      // 点击外部关闭移动端菜单
      document.addEventListener('click', function (e) {
        const mobileMenu = document.getElementById('mobileMenu');
        const menuToggle = document.getElementById('menuToggle');
        if (!mobileMenu.contains(e.target) && !menuToggle.contains(e.target)) {
          mobileMenu.style.display = 'none';
        }
      });
    </script>

    <!-- 2. 封面区 -->
    <section class="hero">
      <div class="container">
        <h1><span>估价引擎</span></h1>
        <p>基于机器学习与GIS技术，提供高精度房地产土地智能估价方案</p>
        <a href="#start-valuation" class="start-valuation-btn">立即开始估价</a>
      </div>
    </section>

    <!-- 3. 估价引擎主要内容 -->
    <section class="valuation-section">
      <div class="container valuation-content">
        <h2>估价引擎功能</h2>

        <div class="valuation-features">
          <div class="valuation-feature">
            <i class="fas fa-brain"></i>
            <h3>AI估算算法</h3>
            <p>
              基于机器学习和深度学习技术，结合海量历史交易数据，提供精准的房地产估价预测。
            </p>
          </div>
          <div class="valuation-feature">
            <i class="fas fa-map-marker-alt"></i>
            <h3>地理位置评估</h3>
            <p>
              结合GIS技术，分析周边配套设施、交通便利性等因素，精准评估地理位置价值。
            </p>
          </div>
          <div class="valuation-feature">
            <i class="fas fa-chart-line"></i>
            <h3>市场趋势分析</h3>
            <p>
              实时监测房地产市场动态，分析价格走势，提供科学的市场预测和投资建议。
            </p>
          </div>
          <div class="valuation-feature">
            <i class="fas fa-file-alt"></i>
            <h3>评估报告生成</h3>
            <p>自动生成专业、详尽的评估报告，包含多种分析维度和可视化图表。</p>
          </div>
          <div class="valuation-feature">
            <i class="fas fa-clock"></i>
            <h3>快速响应</h3>
            <p>采用高性能计算架构，实现秒级估价响应，满足大规模并发请求。</p>
          </div>
          <div class="valuation-feature">
            <i class="fas fa-shield-alt"></i>
            <h3>数据安全保障</h3>
            <p>
              多层安全防护机制，确保数据隐私和系统稳定，通过严格的安全认证。
            </p>
          </div>
        </div>

        <h2 id="start-valuation">开始估价</h2>
        <div
          style="
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
          "
        >
          <form
            id="valuationForm"
            style="
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
              gap: 15px;
            "
          >
            <style>
              /* Form validation and UX enhancements */
              .form-group {
                position: relative;
              }

              .form-group label {
                display: block;
                margin-bottom: 8px;
                font-weight: 500;
                color: #333;
                font-size: 14px;
              }

              .form-group input,
              .form-group select {
                width: 100%;
                padding: 10px;
                border: 1px solid #ddd;
                border-radius: 6px;
                transition: all 0.3s ease;
                font-size: 14px;
                box-sizing: border-box;
              }

              .form-group input:focus,
              .form-group select:focus {
                outline: none;
                border-color: #007aff;
                box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.1);
              }

              /* Valid state */
              .form-group.valid input,
              .form-group.valid select {
                border-color: #4caf50;
              }

              /* Invalid state */
              .form-group.invalid input,
              .form-group.invalid select {
                border-color: #f44336;
              }

              /* Error message */
              .error-message {
                color: #f44336;
                font-size: 12px;
                margin-top: 4px;
                display: block;
              }

              /* Success message */
              .success-message {
                color: #4caf50;
                font-size: 12px;
                margin-top: 4px;
                display: block;
              }

              /* Tooltip */
              .tooltip {
                position: relative;
                display: inline-block;
                margin-left: 5px;
                cursor: help;
                color: #666;
              }

              .tooltip .tooltiptext {
                visibility: hidden;
                width: 200px;
                background-color: #333;
                color: #fff;
                text-align: center;
                border-radius: 6px;
                padding: 8px;
                position: absolute;
                z-index: 1;
                bottom: 125%;
                left: 50%;
                margin-left: -100px;
                opacity: 0;
                transition: opacity 0.3s;
                font-size: 12px;
              }

              .tooltip:hover .tooltiptext {
                visibility: visible;
                opacity: 1;
              }

              /* Loading spinner */
              .spinner {
                border: 3px solid rgba(0, 122, 255, 0.3);
                border-radius: 50%;
                border-top: 3px solid #007aff;
                width: 16px;
                height: 16px;
                animation: spin 1s linear infinite;
                display: inline-block;
                margin-right: 8px;
              }

              @keyframes spin {
                0% {
                  transform: rotate(0deg);
                }
                100% {
                  transform: rotate(360deg);
                }
              }

              /* Responsive adjustments */
              @media (max-width: 768px) {
                #valuationForm {
                  grid-template-columns: 1fr;
                  gap: 12px;
                }

                #valuationForm > div:first-child {
                  grid-column: span 1 !important;
                }

                #valuationResult {
                  padding: 20px;
                }

                #valuationResult > div {
                  grid-template-columns: 1fr !important;
                }

                .start-valuation-btn {
                  padding: 12px 30px !important;
                  font-size: 16px !important;
                }
              }

              /* Chart containers */
              .chart-container {
                position: relative;
                height: 250px;
                width: 100%;
              }

              canvas {
                max-width: 100%;
                height: auto !important;
              }

              /* Table responsive */
              #comparableProperties {
                min-width: 600px;
              }

              @media (max-width: 768px) {
                #comparableProperties {
                  font-size: 12px;
                }

                #comparableProperties th,
                #comparableProperties td {
                  padding: 8px;
                }
              }
            </style>
            <div
              style="
                grid-column: span 2;
                text-align: center;
                margin-bottom: 10px;
              "
            >
              <h3 style="color: #1a73e8; margin-bottom: 10px">
                请填写房产基本信息
              </h3>
              <p style="color: #666">
                我们将根据您提供的信息，使用AI算法为您提供精准的房产估价
              </p>
            </div>

            <!-- 建筑面积 -->
            <div class="form-group">
              <label
                for="area"
                style="display: block; margin-bottom: 8px; font-weight: 500"
                >建筑面积 (㎡)</label
              >
              <input
                type="number"
                id="area"
                name="area"
                min="1"
                step="0.1"
                placeholder="请输入建筑面积"
                required
                style="
                  width: 100%;
                  padding: 10px;
                  border: 1px solid #ddd;
                  border-radius: 6px;
                  transition: border-color 0.3s;
                "
              />
            </div>

            <!-- 地理位置 - 城市选择 -->
            <div class="form-group">
              <label
                for="citySelect"
                style="display: block; margin-bottom: 8px; font-weight: 500"
                >城市</label
              >
              <select
                id="citySelect"
                name="city"
                required
                style="
                  width: 100%;
                  padding: 10px;
                  border: 1px solid #ddd;
                  border-radius: 6px;
                  transition: border-color 0.3s;
                "
              >
                <option value="">选择城市</option>
                <!-- 湖南省内城市（重点城市：长沙优先） -->
                <option value="changsha">长沙</option>
                <option value="zhuzhou">株洲</option>
                <option value="xiangtan">湘潭</option>
                <option value="hengyang">衡阳</option>
                <option value="shaoyang">邵阳</option>
                <option value="yueyang">岳阳</option>
                <option value="changde">常德</option>
                <option value="zhangjiajie">张家界</option>
                <option value="yiyang">益阳</option>
                <option value="chenzhou">郴州</option>
                <option value="yongzhou">永州</option>
                <option value="huaihua">怀化</option>
                <option value="loudi">娄底</option>
                <option value="xiangxi">湘西土家族苗族自治州</option>

                <!-- 其他省份城市 -->
                <option value="beijing">北京</option>
                <option value="shanghai">上海</option>
                <option value="guangzhou">广州</option>
                <option value="shenzhen">深圳</option>
                <option value="hangzhou">杭州</option>
                <option value="wuhan">武汉</option>
                <option value="yichang">宜昌</option>
                <option value="nanchang">南昌</option>
                <option value="jiujiang">九江</option>
                <option value="ganzhou">赣州</option>
                <option value="shaoguan">韶关</option>
                <option value="nanning">南宁</option>
                <option value="guilin">桂林</option>
                <option value="guiyang">贵阳</option>
                <option value="zunyi">遵义</option>
                <option value="chongqing">重庆</option>
                <option value="chengdu">成都</option>
                <option value="xiamen">厦门</option>
              </select>
            </div>

            <!-- 区域选择 -->
            <div class="form-group">
              <label
                for="districtSelect"
                style="display: block; margin-bottom: 8px; font-weight: 500"
                >区域</label
              >
              <select
                id="districtSelect"
                name="district"
                required
                style="
                  width: 100%;
                  padding: 10px;
                  border: 1px solid #ddd;
                  border-radius: 6px;
                  transition: border-color 0.3s;
                "
              >
                <option value="">选择区域</option>
              </select>
            </div>

            <!-- 街道/乡镇选择 -->
            <div class="form-group">
              <label
                for="subdistrictSelect"
                style="display: block; margin-bottom: 8px; font-weight: 500"
                >街道/乡镇</label
              >
              <select
                id="subdistrictSelect"
                name="subdistrict"
                required
                style="
                  width: 100%;
                  padding: 10px;
                  border: 1px solid #ddd;
                  border-radius: 6px;
                  transition: border-color 0.3s;
                "
              >
                <option value="">选择街道/乡镇</option>
              </select>
            </div>

            <!-- 小区选择 -->
            <div class="form-group">
              <label
                for="communitySelect"
                style="display: block; margin-bottom: 8px; font-weight: 500"
                >小区</label
              >
              <select
                id="communitySelect"
                name="community"
                style="
                  width: 100%;
                  padding: 10px;
                  border: 1px solid #ddd;
                  border-radius: 6px;
                  transition: border-color 0.3s;
                "
              >
                <option value="">选择小区（可选）</option>
                <option value="其他">其他</option>
              </select>
            </div>

            <!-- 建筑类型 -->
            <div class="form-group">
              <label
                for="buildingType"
                style="display: block; margin-bottom: 8px; font-weight: 500"
                >建筑类型</label
              >
              <select
                id="buildingType"
                name="buildingType"
                required
                style="
                  width: 100%;
                  padding: 10px;
                  border: 1px solid #ddd;
                  border-radius: 6px;
                  transition: border-color 0.3s;
                "
              >
                <option value="">请选择建筑类型</option>
                <option value="住宅">住宅</option>
                <option value="商业">商业</option>
                <option value="办公">办公</option>
                <option value="别墅">别墅</option>
                <option value="工业">工业</option>
              </select>
            </div>

            <!-- 建成年份 -->
            <div class="form-group">
              <label
                for="constructionYear"
                style="display: block; margin-bottom: 8px; font-weight: 500"
                >建成年份</label
              >
              <input
                type="number"
                id="constructionYear"
                name="constructionYear"
                min="1950"
                max="2025"
                placeholder="请输入建成年份"
                required
                style="
                  width: 100%;
                  padding: 10px;
                  border: 1px solid #ddd;
                  border-radius: 6px;
                  transition: border-color 0.3s;
                "
              />
            </div>

            <!-- 装修等级 -->
            <div class="form-group">
              <label
                for="decorationLevel"
                style="display: block; margin-bottom: 8px; font-weight: 500"
                >装修等级</label
              >
              <select
                id="decorationLevel"
                name="decorationLevel"
                required
                style="
                  width: 100%;
                  padding: 10px;
                  border: 1px solid #ddd;
                  border-radius: 6px;
                  transition: border-color 0.3s;
                "
              >
                <option value="">请选择装修等级</option>
                <option value="rough">毛坯</option>
                <option value="simple">简装</option>
                <option value="medium">中等</option>
                <option value="fine">精装</option>
                <option value="luxury">豪华</option>
              </select>
            </div>

            <!-- 所在楼层 -->
            <div class="form-group">
              <label
                for="floor"
                style="display: block; margin-bottom: 8px; font-weight: 500"
                >所在楼层</label
              >
              <input
                type="number"
                id="floor"
                name="floor"
                min="1"
                placeholder="请输入所在楼层"
                required
                style="
                  width: 100%;
                  padding: 10px;
                  border: 1px solid #ddd;
                  border-radius: 6px;
                  transition: border-color 0.3s;
                "
              />
            </div>

            <!-- 总楼层 -->
            <div class="form-group">
              <label
                for="totalFloors"
                style="display: block; margin-bottom: 8px; font-weight: 500"
                >总楼层</label
              >
              <input
                type="number"
                id="totalFloors"
                name="totalFloors"
                min="1"
                placeholder="请输入总楼层"
                required
                style="
                  width: 100%;
                  padding: 10px;
                  border: 1px solid #ddd;
                  border-radius: 6px;
                  transition: border-color 0.3s;
                "
              />
            </div>

            <!-- 朝向 -->
            <div class="form-group">
              <label
                for="orientation"
                style="display: block; margin-bottom: 8px; font-weight: 500"
                >朝向</label
              >
              <select
                id="orientation"
                name="orientation"
                required
                style="
                  width: 100%;
                  padding: 10px;
                  border: 1px solid #ddd;
                  border-radius: 6px;
                  transition: border-color 0.3s;
                "
              >
                <option value="">请选择朝向</option>
                <option value="north">北</option>
                <option value="south">南</option>
                <option value="east">东</option>
                <option value="west">西</option>
                <option value="northeast">东北</option>
                <option value="northwest">西北</option>
                <option value="southeast">东南</option>
                <option value="southwest">西南</option>
              </select>
            </div>

            <!-- 户型 -->
            <div class="form-group">
              <label
                for="layout"
                style="display: block; margin-bottom: 8px; font-weight: 500"
                >户型</label
              >
              <select
                id="layout"
                name="layout"
                required
                style="
                  width: 100%;
                  padding: 10px;
                  border: 1px solid #ddd;
                  border-radius: 6px;
                  transition: border-color 0.3s;
                "
              >
                <option value="">请选择户型</option>
                <option value="1bed1living">一室一厅</option>
                <option value="2bed1living">两室一厅</option>
                <option value="2bed2living">两室两厅</option>
                <option value="3bed2living">三室两厅</option>
                <option value="4bed2living">四室两厅</option>
                <option value="more">更多</option>
              </select>
            </div>

            <!-- 容积率 -->
            <div class="form-group">
              <label
                for="lotRatio"
                style="display: block; margin-bottom: 8px; font-weight: 500"
                >容积率</label
              >
              <input
                type="number"
                id="lotRatio"
                name="lotRatio"
                min="0.1"
                step="0.1"
                placeholder="请输入容积率，如2.5"
                style="
                  width: 100%;
                  padding: 10px;
                  border: 1px solid #ddd;
                  border-radius: 6px;
                  transition: border-color 0.3s;
                "
              />
            </div>

            <!-- 绿化率 -->
            <div class="form-group">
              <label
                for="greenRatio"
                style="display: block; margin-bottom: 8px; font-weight: 500"
                >绿化率 (%)</label
              >
              <input
                type="number"
                id="greenRatio"
                name="greenRatio"
                min="0"
                max="100"
                placeholder="请输入绿化率，如30"
                style="
                  width: 100%;
                  padding: 10px;
                  border: 1px solid #ddd;
                  border-radius: 6px;
                  transition: border-color 0.3s;
                "
              />
            </div>

            <!-- 周边配套 -->
            <div class="form-group">
              <label
                for="nearbyFacilities"
                style="display: block; margin-bottom: 8px; font-weight: 500"
                >周边配套（用逗号分隔）</label
              >
              <input
                type="text"
                id="nearbyFacilities"
                name="nearbyFacilities"
                placeholder="如：地铁,商场,学校,医院"
                style="
                  width: 100%;
                  padding: 10px;
                  border: 1px solid #ddd;
                  border-radius: 6px;
                  transition: border-color 0.3s;
                "
              />
            </div>

            <!-- 提交按钮 -->
            <div
              style="grid-column: span 2; text-align: center; margin-top: 20px"
            >
              <button
                type="submit"
                class="start-valuation-btn"
                style="
                  padding: 15px 60px;
                  font-size: 18px;
                  border: none;
                  border-radius: 25px;
                  background: linear-gradient(135deg, #007aff, #0056b3);
                  color: white;
                  cursor: pointer;
                  transition: all 0.3s ease;
                "
              >
                开始估价
              </button>
            </div>
          </form>

          <!-- 估价结果展示区域 -->
          <div
            id="valuationResult"
            style="
              margin-top: 40px;
              padding: 30px;
              background: linear-gradient(135deg, #f0f4f8, #e2e8f0);
              border-radius: 8px;
              display: none;
            "
          >
            <h3 style="color: #1a73e8; margin-bottom: 20px; text-align: center">
              估价结果
            </h3>

            <!-- 核心结果展示 -->
            <div
              style="
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                text-align: center;
              "
            >
              <div>
                <div style="font-size: 14px; color: #666; margin-bottom: 5px">
                  预估总价
                </div>
                <div
                  id="totalPrice"
                  style="font-size: 36px; font-weight: bold; color: #1a73e8"
                >
                  --
                </div>
              </div>
              <div>
                <div style="font-size: 14px; color: #666; margin-bottom: 5px">
                  预估单价
                </div>
                <div
                  id="unitPrice"
                  style="font-size: 36px; font-weight: bold; color: #1a73e8"
                >
                  --
                </div>
              </div>
            </div>

            <!-- 辅助信息 -->
            <div
              style="
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin-top: 20px;
                text-align: center;
              "
            >
              <div>
                <div style="font-size: 14px; color: #666; margin-bottom: 5px">
                  置信度
                </div>
                <div
                  id="confidence"
                  style="font-size: 24px; font-weight: bold; color: #4caf50"
                >
                  --
                </div>
              </div>
              <div>
                <div style="font-size: 14px; color: #666; margin-bottom: 5px">
                  估价方法
                </div>
                <div
                  id="valuationMethod"
                  style="font-size: 24px; font-weight: bold; color: #2196f3"
                >
                  --
                </div>
              </div>
            </div>

            <!-- 影响因素分析 -->
            <div style="margin-top: 40px">
              <h4 style="color: #1a73e8; margin-bottom: 20px">影响因素分析</h4>
              <div
                style="
                  background: white;
                  padding: 20px;
                  border-radius: 8px;
                  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                "
              >
                <div class="chart-container">
                  <canvas id="factorsChart"></canvas>
                </div>
              </div>
            </div>

            <!-- 估价方法权重分布（仅综合估价法显示） -->
            <div
              id="methodWeightsSection"
              style="margin-top: 40px; display: none"
            >
              <h4 style="color: #1a73e8; margin-bottom: 20px">
                估价方法权重分布
              </h4>
              <div
                style="
                  background: white;
                  padding: 20px;
                  border-radius: 8px;
                  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                "
              >
                <div class="chart-container">
                  <canvas id="methodWeightsChart"></canvas>
                </div>
              </div>
            </div>

            <!-- 市场趋势分析 -->
            <div style="margin-top: 40px">
              <h4 style="color: #1a73e8; margin-bottom: 20px">市场趋势分析</h4>
              <div
                style="
                  background: white;
                  padding: 20px;
                  border-radius: 8px;
                  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                "
              >
                <div class="chart-container">
                  <canvas id="trendChart"></canvas>
                </div>
              </div>
            </div>

            <!-- 可比案例 -->
            <div style="margin-top: 40px">
              <h4 style="color: #1a73e8; margin-bottom: 20px">可比案例</h4>
              <div
                style="
                  background: white;
                  padding: 20px;
                  border-radius: 8px;
                  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
                  overflow-x: auto;
                "
              >
                <table
                  id="comparableProperties"
                  style="width: 100%; border-collapse: collapse"
                >
                  <thead>
                    <tr style="background: #f5f7fa">
                      <th
                        style="
                          padding: 12px;
                          text-align: left;
                          border-bottom: 2px solid #e0e0e0;
                        "
                      >
                        案例ID
                      </th>
                      <th
                        style="
                          padding: 12px;
                          text-align: left;
                          border-bottom: 2px solid #e0e0e0;
                        "
                      >
                        面积(㎡)
                      </th>
                      <th
                        style="
                          padding: 12px;
                          text-align: left;
                          border-bottom: 2px solid #e0e0e0;
                        "
                      >
                        单价(元/㎡)
                      </th>
                      <th
                        style="
                          padding: 12px;
                          text-align: left;
                          border-bottom: 2px solid #e0e0e0;
                        "
                      >
                        总价
                      </th>
                      <th
                        style="
                          padding: 12px;
                          text-align: left;
                          border-bottom: 2px solid #e0e0e0;
                        "
                      >
                        成交日期
                      </th>
                      <th
                        style="
                          padding: 12px;
                          text-align: left;
                          border-bottom: 2px solid #e0e0e0;
                        "
                      >
                        相似度
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    <!-- 可比案例数据将通过JavaScript动态添加 -->
                  </tbody>
                </table>
              </div>
            </div>

            <!-- 报告生成按钮 -->
            <div style="margin-top: 30px; text-align: center">
              <button
                id="generateReportBtn"
                class="start-valuation-btn"
                style="margin-right: 10px"
              >
                生成估价报告
              </button>
              <button
                id="downloadReportBtn"
                class="start-valuation-btn"
                style="background: linear-gradient(135deg, #4caf50, #388e3c)"
              >
                下载报告
              </button>
            </div>

            <div
              style="
                margin-top: 20px;
                text-align: center;
                color: #666;
                font-size: 14px;
              "
            >
              注：此估价结果仅供参考，实际价值以市场交易为准
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- 4. 页脚 -->
    <footer class="footer">
      <div class="container">
        <div class="footer-col">
          <h3>项目介绍</h3>
          <a href="index.html">首页</a>
          <a href="core-function.html">核心功能</a>
          <a href="tech-frame.html">技术框架</a>
          <a href="project-feature.html">项目特点</a>
        </div>
        <div class="footer-col">
          <h3>团队介绍</h3>
          <a href="team-intro.html">团队成员</a>
          <a href="about-us.html">关于我们</a>
        </div>
        <div class="footer-col">
          <h3>产品服务</h3>
          <a href="product-services.html">服务内容</a>
          <a href="help-center.html">帮助中心</a>
        </div>
        <div class="footer-col">
          <h3>联系我们</h3>
          <a href="#">联系方式</a>
          <a href="#">意见反馈</a>
        </div>
      </div>
      <div class="cooperation-enterprises">
        <span
          >合作企业：湖南智信房地产土地资产评估有限公司 |
          长沙力智数字房产技术发展有限公司</span
        >
      </div>
      <div class="copyright">
        <p>© 2024 数智估价核心引擎 版权所有</p>
        <p>
          <a href="https://beian.miit.gov.cn/" target="_blank"
            >湘ICP备2025144327号-1</a
          >
          |
          <a
            href="https://beian.mps.gov.cn/#/query/webSearch?code=43011202001203"
            target="_blank"
            rel="noreferrer"
            >湘公网安备43011202001203号</a
          >
        </p>
      </div>
    </footer>

    <!-- 返回顶部按钮 -->
    <button id="backToTop" class="back-to-top">
      <i class="fas fa-arrow-up"></i>
    </button>

    <!-- 连接点脚本 -->
    <script type="module" src="connection-point.js"></script>
    <script type="module" src="page-optimizer.js"></script>

    <!-- 城市选择器脚本 -->
    <script src="city-selector.js"></script>

    <!-- 页面特定JavaScript -->
    <script>
      // 页面特定的初始化函数
      function pageInit() {
        console.log('估价引擎页面初始化完成');
        // 初始化时处理从关键词估价页面传递过来的数据
        handleKeywordValuationData();
        // 添加实时验证
        addRealTimeValidation();
        // 初始化城市选择联动
        initCitySelection();
      }

      // 初始化城市选择联动
      let citySelector;
      function initCitySelection() {
        citySelector = initCitySelector(
          'citySelect',
          'districtSelect',
          'subdistrictSelect',
          'communitySelect'
        );
      }

      // 处理从关键词估价页面传递过来的数据
      function handleKeywordValuationData() {
        // 从URL获取估价类型
        const urlParams = new URLSearchParams(window.location.search);
        const valuationType = urlParams.get('type') || 'basic';

        // 从localStorage获取估价数据
        const valuationDataStr = localStorage.getItem('valuationData');
        if (valuationDataStr) {
          const valuationData = JSON.parse(valuationDataStr);
          console.log('从关键词估价页面获取的数据:', valuationData);

          // 显示关键词估价结果摘要
          showKeywordValuationSummary(valuationData);

          // 根据估价类型调整页面功能
          adjustPageByValuationType(valuationType, valuationData);

          // 填充表单数据（如果有）
          fillFormFromKeywordData(valuationData);
        } else {
          // 如果没有关键词数据，根据URL参数调整页面
          adjustPageByValuationType(valuationType, null);
        }
      }

      // 显示关键词估价结果摘要
      function showKeywordValuationSummary(data) {
        const valuationForm = document.getElementById('valuationForm');
        if (!valuationForm) return;

        // 创建摘要容器
        const summaryContainer = document.createElement('div');
        summaryContainer.id = 'keywordValuationSummary';
        summaryContainer.style.cssText = `
                background: linear-gradient(135deg, rgba(26, 115, 232, 0.1), rgba(249, 168, 37, 0.1));
                border: 1px solid rgba(26, 115, 232, 0.2);
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 30px;
                grid-column: span 2;
            `;

        summaryContainer.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0; color: #1a73e8;">关键词估价结果摘要</h4>
                    <button id="hideSummaryBtn" style="background: none; border: 1px solid #1a73e8; color: #1a73e8; padding: 5px 15px; border-radius: 20px; font-size: 12px; cursor: pointer; transition: all 0.3s ease;">
                        <i class="fas fa-times"></i> 关闭摘要
                    </button>
                </div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                    <div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 5px;">关键词</div>
                        <div style="font-size: 16px; font-weight: bold; color: #1a73e8; word-break: break-word;">${data.keyword}</div>
                    </div>
                    <div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 5px;">预估单价</div>
                        <div style="font-size: 16px; font-weight: bold; color: #1a73e8;">${parseInt(data.estimatedPrice).toLocaleString()} 元/平方米</div>
                    </div>
                    <div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 5px;">估价置信度</div>
                        <div style="font-size: 16px; font-weight: bold; color: #4CAF50;">${data.confidence}%</div>
                    </div>
                    <div>
                        <div style="font-size: 14px; color: #666; margin-bottom: 5px;">估价类型</div>
                        <div style="font-size: 16px; font-weight: bold; color: #f9a825;">${getValuationTypeName(data.type)}</div>
                    </div>
                </div>
            `;

        // 添加到表单顶部
        valuationForm.insertBefore(summaryContainer, valuationForm.firstChild);

        // 添加关闭按钮事件
        const hideSummaryBtn = document.getElementById('hideSummaryBtn');
        hideSummaryBtn.addEventListener('click', function () {
          summaryContainer.style.display = 'none';
        });
      }

      // 验证支付状态
      function verifyPaymentStatus(type) {
        // 获取支付状态
        const paymentStatus = JSON.parse(
          localStorage.getItem('paymentStatus') || '{}'
        );

        // 基础版始终可用
        if (type === 'basic') {
          return true;
        }

        // 检查对应类型的支付状态
        return paymentStatus[type] === true;
      }

      // 根据估价类型调整页面功能
      function adjustPageByValuationType(type, data) {
        console.log('调整页面功能，估价类型:', type);

        // 验证支付状态
        const isPaid = verifyPaymentStatus(type);

        // 隐藏或显示不同的功能区域
        const features = {
          basic: ['factorsChart', 'trendChart', 'comparableProperties'],
          advanced: [
            'factorsChart',
            'trendChart',
            'comparableProperties',
            'methodWeightsChart',
          ],
          professional: [
            'factorsChart',
            'trendChart',
            'comparableProperties',
            'methodWeightsChart',
            'detailedReport',
            'commercialAnalysis',
          ],
        };

        // 示例：根据类型显示不同的报告生成选项
        const generateReportBtn = document.getElementById('generateReportBtn');
        if (generateReportBtn) {
          if (type === 'professional') {
            if (isPaid) {
              generateReportBtn.innerHTML =
                '<i class="fas fa-file-alt"></i> 生成专业评估报告';
            } else {
              generateReportBtn.innerHTML =
                '<i class="fas fa-lock"></i> 生成专业评估报告（需支付）';
              generateReportBtn.disabled = true;
            }
          } else if (type === 'advanced') {
            if (isPaid) {
              generateReportBtn.innerHTML =
                '<i class="fas fa-file-alt"></i> 生成高级评估报告';
            } else {
              generateReportBtn.innerHTML =
                '<i class="fas fa-lock"></i> 生成高级评估报告（需支付）';
              generateReportBtn.disabled = true;
            }
          } else {
            generateReportBtn.innerHTML =
              '<i class="fas fa-file-alt"></i> 生成基础评估报告';
          }
        }

        // 根据类型和支付状态显示或隐藏高级功能
        const advancedFeatures = document.querySelectorAll('.advanced-feature');
        advancedFeatures.forEach((feature) => {
          if (type === 'basic' || !isPaid) {
            feature.style.display = 'none';
          } else {
            feature.style.display = 'block';
          }
        });

        // 根据类型和支付状态显示或隐藏专业功能
        const professionalFeatures = document.querySelectorAll(
          '.professional-feature'
        );
        professionalFeatures.forEach((feature) => {
          if (type === 'professional' && isPaid) {
            feature.style.display = 'block';
          } else {
            feature.style.display = 'none';
          }
        });

        // 如果未支付且不是基础版，显示提示
        if (!isPaid && type !== 'basic') {
          showPaymentRequired(type);
        }
      }

      // 显示支付提示
      function showPaymentRequired(type) {
        const container = document.querySelector('.valuation-content');
        if (!container) return;

        // 创建支付提示元素
        const paymentTip = document.createElement('div');
        paymentTip.style.cssText = `
                background: linear-gradient(135deg, rgba(249, 168, 37, 0.1), rgba(255, 193, 7, 0.1));
                border: 1px solid rgba(249, 168, 37, 0.3);
                border-radius: 8px;
                padding: 20px;
                margin-bottom: 30px;
                display: flex;
                align-items: center;
                gap: 15px;
            `;

        paymentTip.innerHTML = `
                <div style="font-size: 24px; color: var(--color-secondary);">
                    <i class="fas fa-info-circle"></i>
                </div>
                <div style="flex: 1;">
                    <h4 style="margin: 0 0 5px;">需支付才能使用高级功能</h4>
                    <p style="margin: 0; color: var(--color-text-light); font-size: 14px;">
                        您选择了${getValuationTypeName(type)}，需要支付相应费用才能访问完整功能
                    </p>
                </div>
                <button id="payNowBtn" style="background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; transition: all 0.3s ease;">
                    <i class="fas fa-lock"></i> 立即支付
                </button>
            `;

        // 添加到页面顶部
        container.insertBefore(paymentTip, container.firstChild.nextSibling);

        // 添加支付按钮事件
        const payNowBtn = document.getElementById('payNowBtn');
        payNowBtn.addEventListener('click', () => {
          // 跳回到关键词估价页面重新选择支付
          window.location.href = 'keyword-valuation.html';
        });
      }

      // 填充表单数据
      function fillFormFromKeywordData(data) {
        // 这里可以根据关键词解析出一些基本信息填充到表单中
        // 示例：如果关键词包含面积信息
        const keyword = data.keyword;
        const areaMatch = keyword.match(/(\d+)平/);
        if (areaMatch && areaMatch[1]) {
          const areaInput = document.getElementById('area');
          if (areaInput) {
            areaInput.value = areaMatch[1];
          }
        }

        // 示例：如果关键词包含装修等级
        const decorationMatch =
          keyword.match(/(毛坯|简装|精装|豪华|中等)装修?/);
        if (decorationMatch && decorationMatch[1]) {
          const decorationSelect = document.getElementById('decorationLevel');
          if (decorationSelect) {
            const decorationMap = {
              毛坯: 'rough',
              简装: 'simple',
              中等: 'medium',
              精装: 'fine',
              豪华: 'luxury',
            };
            const value = decorationMap[decorationMatch[1]];
            if (value) {
              decorationSelect.value = value;
            }
          }
        }

        // 示例：如果关键词包含建筑类型
        const buildingTypeMatch = keyword.match(/(住宅|商业|办公|工业|别墅)/);
        if (buildingTypeMatch && buildingTypeMatch[1]) {
          const buildingTypeSelect = document.getElementById('buildingType');
          if (buildingTypeSelect) {
            buildingTypeSelect.value = buildingTypeMatch[1];
          }
        }
      }

      // 获取估价类型名称
      function getValuationTypeName(type) {
        const typeNames = {
          basic: '基础详细估价',
          advanced: '高级详细估价',
          professional: '专业估价',
        };
        return typeNames[type] || '基础详细估价';
      }

      // 格式化价格
      function formatPrice(price) {
        if (price >= 10000) {
          return (price / 10000).toFixed(2) + ' 万元';
        } else {
          return Math.round(price).toLocaleString() + ' 元';
        }
      }

      // 显示加载状态
      function showLoading() {
        const submitBtn = document.querySelector(
          '#valuationForm button[type="submit"]'
        );
        const originalText = submitBtn.textContent;
        submitBtn.textContent = '正在估价...';
        submitBtn.disabled = true;
        submitBtn.style.opacity = '0.7';
        return originalText;
      }

      // 隐藏加载状态
      function hideLoading(originalText) {
        const submitBtn = document.querySelector(
          '#valuationForm button[type="submit"]'
        );
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
        submitBtn.style.opacity = '1';
      }

      // 显示错误信息
      function showError(message) {
        alert('估价失败：' + message);
      }

      // 提交估价请求到后端API
      async function submitValuation(formData) {
        try {
          const response = await fetch('/api/valuation', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || '估价请求失败');
          }

          const result = await response.json();
          return result.data;
        } catch (error) {
          console.error('估价请求错误:', error);
          throw error;
        }
      }

      // 表单验证函数
      function validateField(fieldId, validationRule) {
        const field = document.getElementById(fieldId);
        const formGroup = field.closest('.form-group');
        let errorMessage = '';

        // 清除之前的状态
        formGroup.classList.remove('valid', 'invalid');
        const existingError = formGroup.querySelector('.error-message');
        if (existingError) {
          existingError.remove();
        }

        // 执行验证规则
        if (validationRule.required && !field.value) {
          errorMessage = '此字段为必填项';
        } else if (validationRule.number && field.value && isNaN(field.value)) {
          errorMessage = '请输入有效的数字';
        } else if (
          validationRule.min &&
          parseFloat(field.value) < validationRule.min
        ) {
          errorMessage = `请输入大于或等于${validationRule.min}的值`;
        } else if (
          validationRule.max &&
          parseFloat(field.value) > validationRule.max
        ) {
          errorMessage = `请输入小于或等于${validationRule.max}的值`;
        }

        // 更新字段状态
        if (errorMessage) {
          formGroup.classList.add('invalid');
          const errorElement = document.createElement('span');
          errorElement.className = 'error-message';
          errorElement.textContent = errorMessage;
          formGroup.appendChild(errorElement);
          return false;
        } else if (field.value) {
          formGroup.classList.add('valid');
        }

        return true;
      }

      // 表单验证
      function validateForm() {
        let isValid = true;

        // 定义验证规则
        const validationRules = {
          area: { required: true, number: true, min: 1 },
          location: { required: true },
          buildingType: { required: true },
          constructionYear: {
            required: true,
            number: true,
            min: 1950,
            max: new Date().getFullYear(),
          },
          decorationLevel: { required: true },
          floor: { required: true, number: true, min: 1 },
          totalFloors: { required: true, number: true, min: 1 },
          orientation: { required: true },
          layout: { required: true },
          lotRatio: { number: true, min: 0.1 },
          greenRatio: { number: true, min: 0, max: 100 },
        };

        // 验证所有字段
        for (const [fieldId, rules] of Object.entries(validationRules)) {
          if (!validateField(fieldId, rules)) {
            isValid = false;
          }
        }

        // 额外验证：楼层不能大于总楼层
        const floor = document.getElementById('floor');
        const totalFloors = document.getElementById('totalFloors');
        const floorGroup = floor.closest('.form-group');

        if (
          floor.value &&
          totalFloors.value &&
          parseInt(floor.value) > parseInt(totalFloors.value)
        ) {
          isValid = false;
          floorGroup.classList.add('invalid');
          const existingError = floorGroup.querySelector('.error-message');
          if (existingError) {
            existingError.remove();
          }
          const errorElement = document.createElement('span');
          errorElement.className = 'error-message';
          errorElement.textContent = '所在楼层不能大于总楼层';
          floorGroup.appendChild(errorElement);
        }

        return isValid;
      }

      // 添加实时验证
      function addRealTimeValidation() {
        const form = document.getElementById('valuationForm');
        if (!form) return;

        const fields = form.querySelectorAll('input, select');

        fields.forEach((field) => {
          field.addEventListener('blur', () => {
            const validationRules = {
              area: { required: true, number: true, min: 1 },
              location: { required: true },
              buildingType: { required: true },
              constructionYear: {
                required: true,
                number: true,
                min: 1950,
                max: new Date().getFullYear(),
              },
              decorationLevel: { required: true },
              floor: { required: true, number: true, min: 1 },
              totalFloors: { required: true, number: true, min: 1 },
              orientation: { required: true },
              layout: { required: true },
              lotRatio: { number: true, min: 0.1 },
              greenRatio: { number: true, min: 0, max: 100 },
            };

            if (validationRules[field.id]) {
              validateField(field.id, validationRules[field.id]);
            }
          });

          // 楼层和总楼层的联动验证
          if (field.id === 'floor' || field.id === 'totalFloors') {
            field.addEventListener('input', () => {
              const floor = document.getElementById('floor');
              const totalFloors = document.getElementById('totalFloors');
              const floorGroup = floor.closest('.form-group');

              if (
                floor.value &&
                totalFloors.value &&
                parseInt(floor.value) > parseInt(totalFloors.value)
              ) {
                floorGroup.classList.add('invalid');
                const existingError =
                  floorGroup.querySelector('.error-message');
                if (existingError) {
                  existingError.remove();
                }
                const errorElement = document.createElement('span');
                errorElement.className = 'error-message';
                errorElement.textContent = '所在楼层不能大于总楼层';
                floorGroup.appendChild(errorElement);
              } else {
                const existingError =
                  floorGroup.querySelector('.error-message');
                if (
                  existingError &&
                  existingError.textContent === '所在楼层不能大于总楼层'
                ) {
                  existingError.remove();
                  // 重新验证楼层字段
                  validateField('floor', {
                    required: true,
                    number: true,
                    min: 1,
                  });
                }
              }
            });
          }
        });
      }

      // 渲染影响因素图表
      function renderFactorsChart(factorsAnalysis) {
        const ctx = document.getElementById('factorsChart').getContext('2d');

        // 准备数据
        const factorNames = factorsAnalysis.map((factor) => factor.name);
        const factorValues = factorsAnalysis.map((factor) => factor.value);
        const factorColors = [
          '#FF6B6B',
          '#4ECDC4',
          '#45B7D1',
          '#96CEB4',
          '#FFEAA7',
          '#DDA0DD',
        ];

        // 创建图表
        new Chart(ctx, {
          type: 'bar',
          data: {
            labels: factorNames,
            datasets: [
              {
                label: '影响因素得分',
                data: factorValues,
                backgroundColor: factorColors,
                borderColor: factorColors.map((color) =>
                  color.replace('0.8', '1')
                ),
                borderWidth: 1,
                borderRadius: 5,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return `${context.parsed.y}%`;
                  },
                },
              },
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 100,
                ticks: {
                  callback: function (value) {
                    return value + '%';
                  },
                },
              },
            },
          },
        });
      }

      // 渲染估价方法权重分布图表
      function renderMethodWeightsChart(weights) {
        const ctx = document
          .getElementById('methodWeightsChart')
          .getContext('2d');

        // 准备数据
        const methodNames = ['市场比较法', '收益法', '成本法'];
        const methodValues = [
          weights.market * 100,
          weights.income * 100,
          weights.cost * 100,
        ];
        const methodColors = ['#FF6B6B', '#4ECDC4', '#45B7D1'];

        // 创建图表
        new Chart(ctx, {
          type: 'pie',
          data: {
            labels: methodNames,
            datasets: [
              {
                data: methodValues,
                backgroundColor: methodColors,
                borderColor: '#fff',
                borderWidth: 2,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
              },
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return `${context.label}: ${context.parsed}%`;
                  },
                },
              },
            },
          },
        });
      }

      // 渲染市场趋势图表
      function renderTrendChart(trendAnalysis) {
        const ctx = document.getElementById('trendChart').getContext('2d');

        // 准备数据
        const months = trendAnalysis.monthlyTrend.map((trend) => trend.month);
        const prices = trendAnalysis.monthlyTrend.map((trend) => trend.price);

        // 创建图表
        new Chart(ctx, {
          type: 'line',
          data: {
            labels: months,
            datasets: [
              {
                label: '价格趋势 (元/㎡)',
                data: prices,
                borderColor: '#007AFF',
                backgroundColor: 'rgba(0, 122, 255, 0.1)',
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointBackgroundColor: '#007AFF',
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              tooltip: {
                callbacks: {
                  label: function (context) {
                    return `${formatPrice(context.parsed.y)}/㎡`;
                  },
                },
              },
            },
            scales: {
              y: {
                beginAtZero: false,
                ticks: {
                  callback: function (value) {
                    return formatPrice(value);
                  },
                },
              },
            },
          },
        });
      }

      // 填充可比案例表格
      function populateComparableProperties(comparableProperties) {
        const tbody = document.querySelector('#comparableProperties tbody');
        tbody.innerHTML = '';

        comparableProperties.forEach((property) => {
          const row = document.createElement('tr');
          row.innerHTML = `
                    <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">${property.caseId}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">${property.area} ㎡</td>
                    <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">${formatPrice(property.unitPrice)}/㎡</td>
                    <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">${formatPrice(property.totalPrice)}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">${property.transactionDate}</td>
                    <td style="padding: 12px; border-bottom: 1px solid #e0e0e0;">${property.similarity}%</td>
                `;
          tbody.appendChild(row);
        });
      }

      // 显示估价结果
      function displayValuationResult(result) {
        const valuationResult = document.getElementById('valuationResult');
        const totalPriceElement = document.getElementById('totalPrice');
        const unitPriceElement = document.getElementById('unitPrice');

        if (valuationResult && totalPriceElement && unitPriceElement) {
          // 格式化价格
          totalPriceElement.textContent = formatPrice(result.totalValue);
          unitPriceElement.textContent = formatPrice(result.unitPrice) + '/㎡';

          // 显示置信度
          const confidenceElement = document.getElementById('confidence');
          if (confidenceElement) {
            confidenceElement.textContent = result.confidence + '%';
          }

          // 显示估价方法
          const methodElement = document.getElementById('valuationMethod');
          if (methodElement) {
            methodElement.textContent = result.valuationMethod;
          }

          // 渲染影响因素图表
          if (result.evaluationDetails?.factorsAnalysis) {
            renderFactorsChart(result.evaluationDetails.factorsAnalysis);
          }

          // 渲染市场趋势图表
          if (result.trendAnalysis) {
            renderTrendChart(result.trendAnalysis);
          }

          // 渲染估价方法权重分布（仅综合估价法显示）
          const methodWeightsSection = document.getElementById(
            'methodWeightsSection'
          );
          if (
            result.valuationMethod === '综合估价法' &&
            result.factors?.weights
          ) {
            methodWeightsSection.style.display = 'block';
            renderMethodWeightsChart(result.factors.weights);
          } else {
            methodWeightsSection.style.display = 'none';
          }

          // 填充可比案例表格
          if (result.comparableProperties) {
            populateComparableProperties(result.comparableProperties);
          }

          // 保存结果到全局变量，供报告生成使用
          window.currentValuationResult = result;

          // 显示结果
          valuationResult.style.display = 'block';

          // 滚动到结果区域
          valuationResult.scrollIntoView({
            behavior: 'smooth',
            block: 'start',
          });
        }
      }

      // 生成估价报告
      async function generateReport() {
        if (!window.currentValuationResult) {
          showError('没有可用于生成报告的估价结果');
          return;
        }

        try {
          const generateBtn = document.getElementById('generateReportBtn');
          const originalText = generateBtn.textContent;
          generateBtn.textContent = '生成中...';
          generateBtn.disabled = true;

          // 这里可以添加报告生成的逻辑
          // 实际项目中可以调用后端API生成报告

          setTimeout(() => {
            generateBtn.textContent = originalText;
            generateBtn.disabled = false;
            alert('报告生成成功！');
          }, 1500);
        } catch (error) {
          showError('报告生成失败：' + error.message);
        }
      }

      // 下载估价报告
      async function downloadReport() {
        if (!window.currentValuationResult) {
          showError('没有可下载的估价报告');
          return;
        }

        try {
          const downloadBtn = document.getElementById('downloadReportBtn');
          const originalText = downloadBtn.textContent;
          downloadBtn.textContent = '下载中...';
          downloadBtn.disabled = true;

          // 调用后端API下载HTML格式报告
          const response = await fetch('/api/valuation/report/html', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              valuationResult: window.currentValuationResult,
            }),
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || '报告下载失败');
          }

          // 处理下载响应
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `估价报告-${window.currentValuationResult.propertyId}.html`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          downloadBtn.textContent = originalText;
          downloadBtn.disabled = false;
        } catch (error) {
          showError('报告下载失败：' + error.message);
          const downloadBtn = document.getElementById('downloadReportBtn');
          downloadBtn.textContent = '下载报告';
          downloadBtn.disabled = false;
        }
      }

      // 页面加载完成后初始化
      document.addEventListener('DOMContentLoaded', function () {
        // 初始化连接点
        if (window.connectionPoint) {
          console.log('连接点已加载，可以使用');

          // 可以在这里添加连接点相关的事件监听器和功能
          // 例如：window.connectionPoint.on('dataUpdated', handleDataUpdated);
        }

        // 页面优化
        if (window.pageOptimizer) {
          window.pageOptimizer.optimize();
        }

        pageInit();

        // 初始化实时验证
        addRealTimeValidation();

        // 移动端菜单切换
        const menuToggle = document.querySelector('.menu-toggle');
        const mobileMenu = document.querySelector('.mobile-menu');

        if (menuToggle && mobileMenu) {
          menuToggle.addEventListener('click', function () {
            mobileMenu.style.display =
              mobileMenu.style.display === 'block' ? 'none' : 'block';
          });
        }

        // 估价表单提交事件
        const valuationForm = document.getElementById('valuationForm');
        if (valuationForm) {
          valuationForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            // 获取表单数据
            const formData = {
              area: parseFloat(document.getElementById('area').value),
              location: {
                city: document.getElementById('citySelect').options[
                  document.getElementById('citySelect').selectedIndex
                ].text,
                district:
                  document.getElementById('districtSelect').options[
                    document.getElementById('districtSelect').selectedIndex
                  ].text,
                subdistrict:
                  document.getElementById('subdistrictSelect').options[
                    document.getElementById('subdistrictSelect').selectedIndex
                  ].text,
                community:
                  document.getElementById('communitySelect').options[
                    document.getElementById('communitySelect').selectedIndex
                  ].text,
              },
              buildingType: document.getElementById('buildingType').value,
              constructionYear: parseInt(
                document.getElementById('constructionYear').value
              ),
              decorationLevel: document.getElementById('decorationLevel').value,
              floor: parseInt(document.getElementById('floor').value),
              totalFloors: parseInt(
                document.getElementById('totalFloors').value
              ),
              orientation: document.getElementById('orientation').value,
              layout: document.getElementById('layout').value,
              lotRatio: parseFloat(
                document.getElementById('lotRatio').value || '2.5'
              ),
              greenRatio: parseFloat(
                document.getElementById('greenRatio').value || '30'
              ),
              nearbyFacilities: document
                .getElementById('nearbyFacilities')
                .value.split(',')
                .map((item) => item.trim())
                .filter(Boolean),
              valuationMethod: '综合估价法', // 默认使用综合估价法
            };

            // 表单提交验证
            if (!validateForm()) {
              showError('请修正表单中的错误后重试');
              return;
            }

            // 显示加载状态
            const originalText = showLoading();

            try {
              // 提交估价请求
              const result = await submitValuation(formData);

              // 显示估价结果
              displayValuationResult(result);
            } catch (error) {
              showError(error.message);
            } finally {
              // 隐藏加载状态
              hideLoading(originalText);
            }
          });
        }

        // 报告生成按钮事件
        const generateReportBtn = document.getElementById('generateReportBtn');
        if (generateReportBtn) {
          generateReportBtn.addEventListener('click', generateReport);
        }

        // 报告下载按钮事件
        const downloadReportBtn = document.getElementById('downloadReportBtn');
        if (downloadReportBtn) {
          downloadReportBtn.addEventListener('click', downloadReport);
        }
      });
    </script>

    <!-- 样本显示模态框 -->
    <div
      id="sampleModal"
      class="modal"
      style="
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
      "
    >
      <div
        class="modal-content"
        style="
          background-color: #fefefe;
          margin: 15% auto;
          padding: 20px;
          border: 1px solid #888;
          width: 80%;
          max-width: 800px;
          border-radius: 10px;
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        "
      >
        <span
          class="close-modal"
          id="closeSampleModal"
          style="
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
          "
          >&times;</span
        >
        <h2 style="margin-top: 0; color: #1d2129">标准样本格式</h2>
        <div style="margin: 20px 0">
          <textarea
            id="sampleContent"
            rows="15"
            style="
              width: 100%;
              padding: 15px;
              font-family: monospace;
              font-size: 14px;
              border: 1px solid #d9d9d9;
              border-radius: 6px;
              resize: none;
            "
            readonly
          ></textarea>
        </div>
        <div style="text-align: right">
          <button
            id="copySampleBtn"
            class="btn btn-primary"
            style="
              background: #1a73e8;
              color: white;
              border: none;
              padding: 10px 20px;
              border-radius: 6px;
              cursor: pointer;
              font-size: 16px;
              transition: all 0.3s;
            "
          >
            <i class="fas fa-copy"></i> 复制样本
          </button>
        </div>
      </div>
    </div>

    <!-- 引入Chart.js用于图表展示 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- 表单提交服务代码 -->
    <script>
      // 样本模态框控制
      const sampleModal = document.getElementById('sampleModal');
      const closeSampleModal = document.getElementById('closeSampleModal');
      const sampleContent = document.getElementById('sampleContent');
      const copySampleBtn = document.getElementById('copySampleBtn');

      // 显示样本模态框
      function showSampleModal(sampleText) {
        sampleContent.value = sampleText;
        sampleModal.style.display = 'block';
        document.body.style.overflow = 'hidden';
      }

      // 关闭样本模态框
      closeSampleModal.onclick = function () {
        sampleModal.style.display = 'none';
        document.body.style.overflow = 'auto';
      };

      // 点击外部关闭样本模态框
      window.onclick = function (event) {
        if (event.target === sampleModal) {
          sampleModal.style.display = 'none';
          document.body.style.overflow = 'auto';
        }
      };

      // 复制样本到剪贴板
      copySampleBtn.onclick = function () {
        sampleContent.select();
        sampleContent.setSelectionRange(0, 99999); // 兼容移动设备
        document.execCommand('copy');
        alert('样本已复制到剪贴板');
      };

      // 表单提交服务类（简化版，完整版本在src/services/FormSubmissionService.js）
      class FormSubmissionService {
        constructor() {
          this.archivedData = JSON.parse(
            localStorage.getItem('formSubmissionArchive') || '[]'
          );
        }

        // 生成唯一ID
        generateId(prefix = 'submission') {
          return `${prefix}-${Date.now()}-${Math.floor(Math.random() * 1000)}`;
        }

        // 验证必填字段
        validateRequired(value) {
          return (
            value !== undefined &&
            value !== null &&
            value.toString().trim() !== ''
          );
        }

        // 规范化表单数据
        normalizeFormData(formData) {
          const normalizedData = {};
          for (const field in formData) {
            if (formData.hasOwnProperty(field)) {
              normalizedData[field] =
                typeof formData[field] === 'string'
                  ? formData[field].trim()
                  : formData[field];
            }
          }

          const now = new Date();
          return {
            ...normalizedData,
            submissionId: this.generateId('valuation-submission'),
            submissionDate: now.toISOString(),
            formattedDate: now.toLocaleString('zh-CN'),
            status: 'pending',
            emailSent: false,
          };
        }

        // 生成标准样本格式
        generateStandardSample(normalizedData) {
          const sampleTemplate =
            `--- 客户估价表单提交样本 ---\n` +
            `提交ID: ${normalizedData.submissionId}\n` +
            `提交时间: ${normalizedData.formattedDate}\n` +
            `--- 基本信息 ---\n` +
            `建筑面积: ${normalizedData.area || '未填写'} ㎡\n` +
            `城市: ${normalizedData.location?.city || '未填写'}\n` +
            `区域: ${normalizedData.location?.district || '未填写'}\n` +
            `街道: ${normalizedData.location?.subdistrict || '未填写'}\n` +
            `小区: ${normalizedData.location?.community || '未填写'}\n` +
            `建筑类型: ${normalizedData.buildingType || '未填写'}\n` +
            `建成年份: ${normalizedData.constructionYear || '未填写'}\n` +
            `装修等级: ${normalizedData.decorationLevel || '未填写'}\n` +
            `所在楼层: ${normalizedData.floor || '未填写'}\n` +
            `总楼层: ${normalizedData.totalFloors || '未填写'}\n` +
            `朝向: ${normalizedData.orientation || '未填写'}\n` +
            `户型: ${normalizedData.layout || '未填写'}\n` +
            `容积率: ${normalizedData.lotRatio || '未填写'}\n` +
            `绿化率: ${normalizedData.greenRatio || '未填写'}%\n` +
            `周边配套: ${normalizedData.nearbyFacilities ? normalizedData.nearbyFacilities.join(', ') : '未填写'}\n` +
            `估价方法: ${normalizedData.valuationMethod || '未填写'}\n` +
            `--- 估价结果 ---\n` +
            `估价总价: ${normalizedData.valuationResult?.totalValue ? `¥${normalizedData.valuationResult.totalValue.toLocaleString()}` : '未生成'} 元\n` +
            `估价单价: ${normalizedData.valuationResult?.unitPrice ? `¥${normalizedData.valuationResult.unitPrice.toLocaleString()}` : '未生成'} 元/㎡\n` +
            `置信度: ${normalizedData.valuationResult?.confidence || '未生成'}%\n` +
            `--- 附加信息 ---\n` +
            `状态: ${normalizedData.status}\n` +
            `邮件发送状态: ${normalizedData.emailSent ? '已发送' : '未发送'}\n` +
            `--- 样本结束 ---`;

          return sampleTemplate;
        }

        // 归档表单数据
        archiveFormData(normalizedData) {
          // 生成标准样本
          const standardSample = this.generateStandardSample(normalizedData);

          // 添加样本到数据中
          const archivedItem = {
            ...normalizedData,
            standardSample,
          };

          // 保存到归档列表
          this.archivedData.unshift(archivedItem);
          localStorage.setItem(
            'formSubmissionArchive',
            JSON.stringify(this.archivedData)
          );

          return archivedItem;
        }

        // 发送邮件（模拟实现）
        async sendEmail(archivedItem, recipient) {
          try {
            // 模拟邮件发送延迟
            await new Promise((resolve) => setTimeout(resolve, 1000));

            // 构建邮件内容
            const emailContent = {
              to: recipient,
              subject: `客户估价表单提交 - ${archivedItem.submissionId}`,
              body: `尊敬的收件人：\n\n您收到了一份新的客户估价表单提交，详情如下：\n\n${archivedItem.standardSample}\n\n请及时处理。\n\n此致，\n表单系统`,
            };

            // 模拟发送成功
            console.log('[邮件发送模拟] 邮件已发送:', {
              recipient: emailContent.to,
              subject: emailContent.subject,
              content: emailContent.body,
            });

            // 更新归档数据状态
            archivedItem.emailSent = true;
            archivedItem.status = 'completed';
            localStorage.setItem(
              'formSubmissionArchive',
              JSON.stringify(this.archivedData)
            );

            return true;
          } catch (error) {
            console.error('发送邮件失败:', error);
            // 更新归档数据状态
            archivedItem.status = 'failed';
            localStorage.setItem(
              'formSubmissionArchive',
              JSON.stringify(this.archivedData)
            );
            throw new Error('邮件发送失败');
          }
        }

        // 完整的表单提交流程
        async submitForm(formData, recipient) {
          try {
            // 1. 验证表单数据
            if (!this.validateRequired(formData.area)) {
              throw new Error('请输入建筑面积');
            }
            if (!this.validateRequired(formData.location?.city)) {
              throw new Error('请选择城市');
            }
            if (!this.validateRequired(formData.buildingType)) {
              throw new Error('请选择建筑类型');
            }
            if (!this.validateRequired(formData.constructionYear)) {
              throw new Error('请输入建成年份');
            }
            if (!this.validateRequired(formData.decorationLevel)) {
              throw new Error('请选择装修等级');
            }

            // 2. 规范化表单数据
            const normalizedData = this.normalizeFormData(formData);

            // 3. 归档表单数据
            const archivedItem = this.archiveFormData(normalizedData);

            // 4. 发送邮件
            await this.sendEmail(archivedItem, recipient);

            return {
              success: true,
              message: '表单提交成功，邮件已发送',
              data: archivedItem,
            };
          } catch (error) {
            console.error('表单提交流程失败:', error);
            return {
              success: false,
              message: error.message,
              data: null,
            };
          }
        }
      }

      // 创建表单提交服务实例
      const formSubmissionService = new FormSubmissionService();

      // 修改表单提交处理函数，添加表单提交服务调用
      document.addEventListener('DOMContentLoaded', function () {
        const valuationForm = document.getElementById('valuationForm');
        if (valuationForm) {
          // 保存原始的表单提交事件处理函数
          const originalSubmit = valuationForm.onsubmit;

          // 重新绑定表单提交事件
          valuationForm.addEventListener('submit', async function (e) {
            e.preventDefault();

            // 获取表单数据
            const formData = {
              area: parseFloat(document.getElementById('area').value),
              location: {
                city: document.getElementById('citySelect').options[
                  document.getElementById('citySelect').selectedIndex
                ].text,
                district:
                  document.getElementById('districtSelect').options[
                    document.getElementById('districtSelect').selectedIndex
                  ].text,
                subdistrict:
                  document.getElementById('subdistrictSelect').options[
                    document.getElementById('subdistrictSelect').selectedIndex
                  ].text,
                community:
                  document.getElementById('communitySelect').options[
                    document.getElementById('communitySelect').selectedIndex
                  ].text,
              },
              buildingType: document.getElementById('buildingType').value,
              constructionYear: parseInt(
                document.getElementById('constructionYear').value
              ),
              decorationLevel: document.getElementById('decorationLevel').value,
              floor: parseInt(document.getElementById('floor').value),
              totalFloors: parseInt(
                document.getElementById('totalFloors').value
              ),
              orientation: document.getElementById('orientation').value,
              layout: document.getElementById('layout').value,
              lotRatio: parseFloat(
                document.getElementById('lotRatio').value || '2.5'
              ),
              greenRatio: parseFloat(
                document.getElementById('greenRatio').value || '30'
              ),
              nearbyFacilities: document
                .getElementById('nearbyFacilities')
                .value.split(',')
                .map((item) => item.trim())
                .filter(Boolean),
              valuationMethod: '综合估价法', // 默认使用综合估价法
            };

            // 表单提交验证
            if (!validateForm()) {
              showError('请修正表单中的错误后重试');
              return;
            }

            // 显示加载状态
            const originalText = showLoading();

            try {
              // 提交估价请求
              const result = await submitValuation(formData);

              // 显示估价结果
              displayValuationResult(result);

              // 添加估价结果到表单数据中
              const formDataWithResult = {
                ...formData,
                valuationResult: result,
              };

              // 使用表单提交服务处理表单
              const submissionResult = await formSubmissionService.submitForm(
                formDataWithResult,
                'lichengyu@fangsuanyun.cn'
              );

              if (submissionResult.success) {
                // 显示样本模态框
                showSampleModal(submissionResult.data.standardSample);
              } else {
                console.error('表单提交服务失败:', submissionResult.message);
              }
            } catch (error) {
              showError(error.message);
            } finally {
              // 隐藏加载状态
              hideLoading(originalText);
            }
          });
        }
      });
    </script>

    <!-- 引入共享JavaScript -->
    <script type="module" src="shared.js"></script>
  </body>
</html>
