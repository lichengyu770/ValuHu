# 测试环境配置指南

本文档提供房产数据管理系统测试环境的配置说明，包括环境要求、部署步骤和维护注意事项。

## 环境要求

### 服务器配置

- **操作系统**：CentOS 7+/Ubuntu 20.04+
- **CPU**：至少 4 核
- **内存**：至少 8GB RAM
- **存储空间**：至少 100GB SSD
- **网络**：稳定的公网访问

### 软件环境

- **Node.js**：v16.x LTS
- **Nginx**：v1.20+（作为反向代理）
- **Redis**：v6.x+（用于缓存）
- **数据库**：MySQL 8.0+ 或 PostgreSQL 13+
- **CI/CD**：Jenkins 或 GitHub Actions

## 部署流程

### 1. 服务器环境准备

#### 安装 Node.js

```bash
# 安装 Node.js v16.x (Ubuntu)
curl -fsSL https://deb.nodesource.com/setup_16.x | sudo -E bash -
sudo apt-get install -y nodejs

# CentOS
curl -sL https://rpm.nodesource.com/setup_16.x | sudo bash -
sudo yum install -y nodejs
```

#### 安装 Nginx

```bash
# Ubuntu
sudo apt-get update
sudo apt-get install -y nginx

# CentOS
sudo yum install -y epel-release
sudo yum install -y nginx

# 启动 Nginx
sudo systemctl start nginx
sudo systemctl enable nginx
```

#### 安装 Redis

```bash
# Ubuntu
sudo apt-get install -y redis-server

# CentOS
sudo yum install -y redis

# 启动 Redis
sudo systemctl start redis
sudo systemctl enable redis
```

### 2. 数据库配置

#### MySQL 安装和配置

```bash
# Ubuntu
sudo apt-get install -y mysql-server

# CentOS
sudo yum localinstall https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm
sudo yum install -y mysql-community-server
sudo systemctl start mysqld
sudo systemctl enable mysqld
```

创建数据库和用户：

```sql
-- 登录 MySQL
mysql -u root -p

-- 创建数据库
CREATE DATABASE realestate_system_test CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户并授权
CREATE USER 'realestate_test'@'%' IDENTIFIED BY 'your_secure_password';
GRANT ALL PRIVILEGES ON realestate_system_test.* TO 'realestate_test'@'%';
FLUSH PRIVILEGES;
```

### 3. 应用部署

#### 代码部署

使用 CI/CD 工具或手动部署：

```bash
# 创建部署目录
sudo mkdir -p /var/www/realestate-test

# 克隆代码（手动部署示例）
cd /var/www/realestate-test
sudo git clone <repository-url> .
sudo git checkout develop  # 测试环境通常使用 develop 分支

# 安装依赖
sudo npm install --production

# 构建项目
sudo npm run build
```

#### 配置环境变量

在服务器上创建 `.env` 文件：

```bash
cd /var/www/realestate-test
sudo cp .env.example .env
sudo nano .env
```

编辑 `.env` 文件，配置测试环境变量：

```dotenv
# 测试环境配置
NODE_ENV=test

# 服务配置
PORT=3000
HOST=0.0.0.0

# 数据库配置
DATABASE_URL=mysql://realestate_test:your_secure_password@localhost:3306/realestate_system_test

# Redis 配置
REDIS_URL=redis://localhost:6379/1

# API 配置
API_PREFIX=/api/v1

# JWT 配置
JWT_SECRET=test_jwt_secret_key_change_in_production
JWT_EXPIRES_IN=86400

# 百度地图配置
BAIDU_MAP_AK=your_test_baidu_map_api_key

# 云存储配置
OSS_REGION=oss-cn-shanghai
OSS_BUCKET=your_test_oss_bucket
OSS_ACCESS_KEY=your_test_access_key_id
OSS_SECRET_KEY=your_test_access_key_secret

# 短信服务配置
SMS_ACCESS_KEY=your_test_sms_access_key
SMS_SECRET_KEY=your_test_sms_secret_key
SMS_SIGN_NAME=your_test_sms_sign_name

# 日志配置
LOG_LEVEL=info
LOG_FORMAT=combined

# 文件上传配置
UPLOAD_MAX_SIZE=10485760
UPLOAD_ALLOWED_TYPES=image/jpeg,image/png,application/pdf
```

### 4. 配置 Nginx

创建 Nginx 配置文件：

```bash
sudo nano /etc/nginx/sites-available/realestate-test
```

添加以下配置：

```nginx
server {
    listen 80;
    server_name test.realestate.example.com;  # 替换为实际的测试环境域名

    root /var/www/realestate-test/build;
    index index.html;

    # 前端静态资源缓存
    location / {
        try_files $uri $uri/ /index.html;
        add_header Cache-Control "public, max-age=3600";
    }

    # API 请求代理
    location /api {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
    }

    # 静态资源配置
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires 7d;
        add_header Cache-Control "public, no-transform";
    }

    # 错误页面
    error_page 404 /404.html;
    location = /404.html {
        internal;
    }

    error_page 500 502 503 504 /500.html;
    location = /500.html {
        internal;
    }
}
```

启用配置并重启 Nginx：

```bash
sudo ln -s /etc/nginx/sites-available/realestate-test /etc/nginx/sites-enabled/
sudo nginx -t  # 测试配置是否正确
sudo systemctl reload nginx
```

### 5. 使用 PM2 管理应用进程

安装 PM2 并配置应用：

```bash
# 安装 PM2
sudo npm install -g pm2

# 启动应用
cd /var/www/realestate-test
pm2 start server.js --name "realestate-test"

# 设置开机自启动
pm2 startup
pm2 save
```

## 测试环境管理

### 定期数据刷新

为了确保测试数据的有效性，建议定期（如每周）刷新测试环境数据：

```bash
# 示例：导入测试数据
sudo mysql -u realestate_test -p realestate_system_test < test_data_dump.sql
```

### 日志管理

查看应用日志：

```bash
# 使用 PM2 查看日志
pm2 logs realestate-test

# 查看 Nginx 访问日志
sudo tail -f /var/log/nginx/access.log

# 查看 Nginx 错误日志
sudo tail -f /var/log/nginx/error.log
```

### 监控

建议配置监控工具（如 Prometheus + Grafana）监控测试环境性能。

## 安全注意事项

1. 确保测试环境使用独立的数据库和账户
2. 使用测试专用的 API 密钥和凭证
3. 不要在测试环境中使用生产数据
4. 限制测试环境的访问权限
5. 定期更新依赖包以修复安全漏洞

## 常见问题排查

### 应用无法启动

- 检查端口是否被占用
- 验证环境变量配置是否正确
- 查看应用日志了解具体错误

### Nginx 404 错误

- 确认静态文件路径正确
- 检查构建文件是否存在
- 验证 Nginx 配置是否正确

### 数据库连接失败

- 验证数据库服务是否运行
- 检查数据库用户名和密码
- 确认数据库连接字符串格式正确

## 维护计划

1. **每日**：检查应用日志和错误报告
2. **每周**：刷新测试数据，更新依赖包
3. **每月**：进行安全扫描，优化性能

---

文档最后更新时间：2024-01-01
