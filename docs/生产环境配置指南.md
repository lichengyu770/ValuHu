# 生产环境配置指南

本文档提供房产数据管理系统生产环境的详细配置步骤、部署方案和运维注意事项，确保系统在生产环境中稳定、安全地运行。

## 环境要求

### 服务器配置

- **操作系统**：CentOS 7+/Ubuntu 20.04+（推荐 CentOS 7）
- **CPU**：至少 8 核（建议 16 核以上）
- **内存**：至少 16GB RAM（建议 32GB 以上）
- **存储空间**：至少 500GB SSD（建议使用 RAID 存储）
- **网络**：千兆网卡，稳定的公网访问

### 软件环境

- **Node.js**：v16.x LTS（锁定版本）
- **Nginx**：v1.20+（反向代理）
- **Redis**：v6.x+（缓存和会话存储）
- **数据库**：MySQL 8.0+ 或 PostgreSQL 13+（主从架构）
- **负载均衡**：Nginx 或专用硬件负载均衡器
- **容器化**（可选）：Docker + Kubernetes

## 安全加固

### 系统级安全

1. **用户管理**
   - 创建专用的应用运行用户，避免使用 root
   - 禁用 SSH 密码登录，仅允许密钥认证
   - 限制 SSH 端口访问（建议修改默认端口）

   ```bash
   # 创建应用用户
   sudo useradd -m realestate -s /bin/bash
   sudo mkdir -p /home/realestate/.ssh
   sudo chmod 700 /home/realestate/.ssh
   ```

2. **防火墙配置**
   - 仅开放必要端口（80, 443, SSH 端口）
   - 配置 iptables 或 firewalld

   ```bash
   # CentOS 防火墙配置
   sudo firewall-cmd --permanent --add-service=http
   sudo firewall-cmd --permanent --add-service=https
   sudo firewall-cmd --permanent --add-port=2222/tcp  # 假设 SSH 端口为 2222
   sudo firewall-cmd --reload
   ```

3. **系统更新**
   - 定期更新系统补丁
   - 启用自动安全更新

   ```bash
   # Ubuntu 自动更新配置
   sudo apt-get install unattended-upgrades
   sudo dpkg-reconfigure --priority=low unattended-upgrades
   ```

### 应用级安全

1. **HTTPS 配置**
   - 使用 Let's Encrypt 或商业 SSL 证书
   - 配置强制 HTTPS 跳转

2. **安全头部设置**
   - 配置安全相关的 HTTP 头部

3. **数据加密**
   - 敏感数据（如用户密码）使用加密存储
   - 数据库连接使用 SSL 加密

## 部署架构

### 推荐架构

- **前端**：Nginx + CDN
- **后端**：Node.js 应用集群（PM2 管理）
- **数据库**：MySQL 主从架构
- **缓存**：Redis 集群
- **文件存储**：云存储服务（OSS/COS）
- **日志**：ELK 日志分析系统

### 部署流程

#### 1. 数据库部署

```bash
# 安装 MySQL 8.0（CentOS）
sudo yum localinstall https://dev.mysql.com/get/mysql80-community-release-el7-3.noarch.rpm
sudo yum install mysql-community-server
sudo systemctl start mysqld
sudo systemctl enable mysqld

# 安全初始化
mysql_secure_installation
```

创建数据库和用户：

```sql
CREATE DATABASE realestate_system CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER 'realestate_prod'@'%' IDENTIFIED BY 'ComplexPassword123!';
GRANT ALL PRIVILEGES ON realestate_system.* TO 'realestate_prod'@'%';
FLUSH PRIVILEGES;
```

配置主从复制（略）。

#### 2. 应用部署

使用 CI/CD 工具（如 Jenkins、GitLab CI）进行自动化部署：

```bash
# 创建部署目录
sudo mkdir -p /var/www/realestate-prod
sudo chown -R realestate:realestate /var/www/realestate-prod

# 克隆代码
su - realestate
cd /var/www/realestate-prod
git clone <repository-url> .
git checkout main  # 生产环境使用 main/master 分支
```

#### 3. 环境配置

创建 `.env.production` 文件：

```dotenv
# 生产环境配置
NODE_ENV=production

# 服务配置
PORT=3000
HOST=0.0.0.0

# 数据库配置
DATABASE_URL=mysql://realestate_prod:ComplexPassword123!@localhost:3306/realestate_system
DATABASE_SSL=true

# Redis 配置
REDIS_URL=redis://localhost:6379/0
REDIS_PASSWORD=redis_password

# API 配置
API_PREFIX=/api/v1

# JWT 配置
JWT_SECRET=production_jwt_secret_key_must_be_changed
JWT_EXPIRES_IN=3600

# 百度地图配置
BAIDU_MAP_AK=production_baidu_map_api_key

# 云存储配置
OSS_REGION=oss-cn-shanghai
OSS_BUCKET=production_oss_bucket
OSS_ACCESS_KEY=production_access_key_id
OSS_SECRET_KEY=production_access_key_secret

# 短信服务配置
SMS_ACCESS_KEY=production_sms_access_key
SMS_SECRET_KEY=production_sms_secret_key
SMS_SIGN_NAME=production_sms_sign_name

# 日志配置
LOG_LEVEL=error
LOG_FORMAT=combined
LOG_OUTPUT=/var/log/realestate-system.log

# 文件上传配置
UPLOAD_MAX_SIZE=5242880
UPLOAD_ALLOWED_TYPES=image/jpeg,image/png,application/pdf

# 性能配置
NODE_OPTIONS=--max-old-space-size=4096

# 安全配置
CORS_ORIGINS=https://yourdomain.com
CSRF_PROTECTION=true
RATE_LIMIT_ENABLED=true
RATE_LIMIT_WINDOW_MS=60000
RATE_LIMIT_MAX=100
```

#### 4. Nginx 配置

创建 Nginx 配置文件：

```bash
sudo nano /etc/nginx/conf.d/realestate-prod.conf
```

添加以下配置：

```nginx
upstream realestate_app {
    server localhost:3000;
    server localhost:3001;
    server localhost:3002;
}

server {
    listen 80;
    server_name realestate.example.com;
    return 301 https://$host$request_uri;
}

server {
    listen 443 ssl http2;
    server_name realestate.example.com;

    # SSL 配置
    ssl_certificate /etc/nginx/ssl/realestate.example.com.crt;
    ssl_certificate_key /etc/nginx/ssl/realestate.example.com.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers 'ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384';
    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:10m;
    ssl_session_tickets off;
    ssl_stapling on;
    ssl_stapling_verify on;

    # 安全头部
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Content-Type-Options nosniff;
    add_header X-Frame-Options SAMEORIGIN;
    add_header X-XSS-Protection "1; mode=block";
    add_header Referrer-Policy "strict-origin-when-cross-origin";

    # 前端静态资源
    location / {
        root /var/www/realestate-prod/build;
        index index.html;
        try_files $uri $uri/ /index.html;
        expires 7d;
        add_header Cache-Control "public, no-transform";
    }

    # API 请求代理
    location /api {
        proxy_pass http://realestate_app;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;
        proxy_read_timeout 300;
        proxy_send_timeout 300;
    }

    # 错误页面
    error_page 404 /404.html;
    location = /404.html {
        internal;
    }

    error_page 500 502 503 504 /500.html;
    location = /500.html {
        internal;
    }

    # 日志配置
    access_log /var/log/nginx/realestate-access.log;
    error_log /var/log/nginx/realestate-error.log;
}
```

#### 5. PM2 配置

使用 PM2 部署 Node.js 应用集群：

```bash
cd /var/www/realestate-prod

# 安装依赖（生产环境）
npm install --production

# 构建应用
npm run build

# 配置 PM2
cat > ecosystem.config.js << EOF
module.exports = {
  apps : [
    {
      name: 'realestate-api',
      script: 'server.js',
      instances: 'max',
      exec_mode: 'cluster',
      env: {
        NODE_ENV: 'production',
        PORT: 3000,
        // 可以在这里设置环境变量，或使用 .env 文件
      },
      log_date_format: 'YYYY-MM-DD HH:mm:ss',
      error_file: '/var/log/realestate/error.log',
      out_file: '/var/log/realestate/output.log',
      merge_logs: true,
      max_restarts: 5,
      restart_delay: 5000,
      max_memory_restart: '4G'
    }
  ]
};
EOF

# 创建日志目录
mkdir -p /var/log/realestate

# 启动应用
pm2 start ecosystem.config.js

# 设置开机自启
pm2 startup
pm2 save
```

## 性能优化

### 应用优化

1. **代码优化**
   - 使用生产模式构建
   - 代码分割和懒加载
   - 压缩静态资源

2. **缓存策略**
   - 浏览器缓存：设置合理的 Cache-Control 头
   - CDN 缓存：配置 CDN 缓存规则
   - Redis 缓存：缓存热点数据

3. **数据库优化**
   - 索引优化
   - 连接池配置
   - 查询优化

### 服务器优化

1. **Nginx 优化**
   - 调整 worker_processes 和 worker_connections
   - 启用 gzip 压缩
   - 配置 keepalive

   ```nginx
   # 优化配置示例
   worker_processes auto;
   worker_rlimit_nofile 65535;

   events {
       worker_connections 10000;
       multi_accept on;
   }

   http {
       sendfile on;
       tcp_nopush on;
       tcp_nodelay on;
       keepalive_timeout 65;
       keepalive_requests 1000;

       gzip on;
       gzip_comp_level 6;
       gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;
   }
   ```

2. **Node.js 优化**
   - 使用 cluster 模式
   - 调整内存限制
   - 使用 PM2 负载均衡

## 监控与告警

### 推荐监控方案

1. **系统监控**
   - Prometheus + Grafana：监控服务器资源
   - Node Exporter：收集系统指标

2. **应用监控**
   - PM2 Monitoring
   - Sentry：错误跟踪

3. **数据库监控**
   - MySQL Exporter
   - 慢查询日志分析

4. **告警配置**
   - 配置邮件、短信告警
   - 设置关键指标告警阈值

## 备份策略

### 数据库备份

```bash
# 每日全量备份脚本
#!/bin/bash
BACKUP_DIR="/backup/mysql"
DATE=$(date +%Y%m%d)

mkdir -p $BACKUP_DIR
mysqldump -u realestate_prod -p --all-databases | gzip > "$BACKUP_DIR/mysql-backup-$DATE.sql.gz"

# 保留最近 7 天的备份
find $BACKUP_DIR -name "mysql-backup-*.sql.gz" -mtime +7 -delete
```

### 文件备份

```bash
# 应用配置和日志备份
#!/bin/bash
BACKUP_DIR="/backup/app"
DATE=$(date +%Y%m%d)

mkdir -p $BACKUP_DIR
tar -czf "$BACKUP_DIR/app-config-$DATE.tar.gz" /var/www/realestate-prod/.env /var/www/realestate-prod/ecosystem.config.js /etc/nginx/conf.d/

# 保留最近 30 天的备份
find $BACKUP_DIR -name "app-config-*.tar.gz" -mtime +30 -delete
```

## 灾难恢复

1. **数据库恢复**

   ```bash
   gunzip < /backup/mysql/mysql-backup-YYYYMMDD.sql.gz | mysql -u realestate_prod -p
   ```

2. **应用恢复**
   - 从备份恢复配置文件
   - 重启应用服务

3. **故障转移**
   - 配置数据库主从切换
   - 准备备用服务器

## 日常运维任务

1. **每日检查**
   - 应用日志检查
   - 系统资源监控
   - 数据库性能检查

2. **每周任务**
   - 系统补丁更新
   - 备份验证
   - 安全扫描

3. **每月任务**
   - 性能优化
   - 资源规划
   - 安全审计

## 安全审计

1. **定期安全扫描**
   - 使用工具如 OpenVAS 扫描系统漏洞
   - 检查依赖包安全漏洞：`npm audit`

2. **日志审计**
   - 分析访问日志，识别可疑活动
   - 检查数据库操作日志

3. **权限审计**
   - 定期检查用户权限
   - 审计云服务访问密钥

---

文档最后更新时间：2024-01-01
