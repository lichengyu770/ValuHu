# 环境变量说明文档

本文档详细说明房产数据管理系统所需的环境变量配置，包括各环境（开发、测试、生产）中可能使用的所有环境变量。开发人员和运维人员可以参考此文档进行环境配置。

## 环境变量分类

环境变量按功能分为以下几类：

- **基础环境配置**
- **数据库配置**
- **Redis 配置**
- **API 配置**
- **JWT 配置**
- **第三方服务配置**
- **日志配置**
- **文件上传配置**
- **性能配置**
- **安全配置**

## 基础环境配置

| 环境变量名   | 类型   | 默认值        | 说明                                          | 必需 | 环境要求 |
| ------------ | ------ | ------------- | --------------------------------------------- | ---- | -------- |
| `NODE_ENV`   | String | `development` | 环境模式：`development`、`test`、`production` | 是   | 所有环境 |
| `PORT`       | Number | `3000`        | 应用监听端口                                  | 是   | 所有环境 |
| `HOST`       | String | `0.0.0.0`     | 应用监听主机                                  | 是   | 所有环境 |
| `PUBLIC_URL` | String | `/`           | 应用基础路径，用于部署在子路径时              | 否   | 生产环境 |

## 数据库配置

### MySQL 配置

| 环境变量名          | 类型    | 默认值  | 说明                                                             | 必需 | 环境要求      |
| ------------------- | ------- | ------- | ---------------------------------------------------------------- | ---- | ------------- |
| `DATABASE_URL`      | String  | -       | 数据库连接字符串，格式：`mysql://用户名:密码@主机:端口/数据库名` | 是   | 所有环境      |
| `DATABASE_SSL`      | Boolean | `false` | 是否使用 SSL 连接数据库                                          | 否   | 测试/生产环境 |
| `DATABASE_POOL_MIN` | Number  | `5`     | 数据库连接池最小连接数                                           | 否   | 所有环境      |
| `DATABASE_POOL_MAX` | Number  | `20`    | 数据库连接池最大连接数                                           | 否   | 所有环境      |
| `DATABASE_TIMEOUT`  | Number  | `30000` | 数据库查询超时时间（毫秒）                                       | 否   | 所有环境      |

### PostgreSQL 配置（可选）

| 环境变量名        | 类型    | 默认值  | 说明                    | 必需 | 环境要求      |
| ----------------- | ------- | ------- | ----------------------- | ---- | ------------- |
| `PG_DATABASE_URL` | String  | -       | PostgreSQL 连接字符串   | 否   | 所有环境      |
| `PG_SSL`          | Boolean | `false` | PostgreSQL 是否使用 SSL | 否   | 测试/生产环境 |

## Redis 配置

| 环境变量名                     | 类型   | 默认值                     | 说明                     | 必需 | 环境要求      |
| ------------------------------ | ------ | -------------------------- | ------------------------ | ---- | ------------- |
| `REDIS_URL`                    | String | `redis://localhost:6379/0` | Redis 连接字符串         | 是   | 所有环境      |
| `REDIS_PASSWORD`               | String | -                          | Redis 密码               | 否   | 测试/生产环境 |
| `REDIS_PREFIX`                 | String | `realestate:`              | Redis 键前缀             | 否   | 所有环境      |
| `REDIS_TTL`                    | Number | `3600`                     | Redis 默认过期时间（秒） | 否   | 所有环境      |
| `REDIS_MAX_RECONNECT_ATTEMPTS` | Number | `10`                       | Redis 最大重连次数       | 否   | 所有环境      |

## API 配置

| 环境变量名                 | 类型    | 默认值    | 说明                     | 必需 | 环境要求      |
| -------------------------- | ------- | --------- | ------------------------ | ---- | ------------- |
| `API_PREFIX`               | String  | `/api/v1` | API 基础路径前缀         | 是   | 所有环境      |
| `API_TIMEOUT`              | Number  | `30000`   | API 请求超时时间（毫秒） | 否   | 所有环境      |
| `API_RATE_LIMIT_ENABLED`   | Boolean | `false`   | 是否启用 API 速率限制    | 否   | 测试/生产环境 |
| `API_RATE_LIMIT_WINDOW_MS` | Number  | `60000`   | 速率限制窗口时间（毫秒） | 否   | 测试/生产环境 |
| `API_RATE_LIMIT_MAX`       | Number  | `100`     | 每个窗口允许的最大请求数 | 否   | 测试/生产环境 |

## JWT 配置

| 环境变量名               | 类型   | 默认值    | 说明                         | 必需 | 环境要求 |
| ------------------------ | ------ | --------- | ---------------------------- | ---- | -------- |
| `JWT_SECRET`             | String | -         | JWT 签名密钥，必须保密且复杂 | 是   | 所有环境 |
| `JWT_EXPIRES_IN`         | Number | `3600`    | JWT 过期时间（秒）           | 是   | 所有环境 |
| `JWT_REFRESH_SECRET`     | String | -         | 刷新令牌签名密钥             | 是   | 所有环境 |
| `JWT_REFRESH_EXPIRES_IN` | Number | `2592000` | 刷新令牌过期时间（秒）       | 是   | 所有环境 |
| `JWT_ALGORITHM`          | String | `HS256`   | JWT 加密算法                 | 否   | 所有环境 |

## 第三方服务配置

### 百度地图 API

| 环境变量名     | 类型   | 默认值 | 说明                                | 必需 | 环境要求      |
| -------------- | ------ | ------ | ----------------------------------- | ---- | ------------- |
| `BAIDU_MAP_AK` | String | -      | 百度地图 API Key                    | 是   | 所有环境      |
| `BAIDU_MAP_SK` | String | -      | 百度地图 Secret Key（用于签名验证） | 否   | 测试/生产环境 |

### 阿里云 OSS

| 环境变量名       | 类型   | 默认值            | 说明                | 必需 | 环境要求 |
| ---------------- | ------ | ----------------- | ------------------- | ---- | -------- |
| `OSS_REGION`     | String | `oss-cn-shanghai` | OSS 区域            | 是   | 所有环境 |
| `OSS_BUCKET`     | String | -                 | OSS 存储桶名称      | 是   | 所有环境 |
| `OSS_ACCESS_KEY` | String | -                 | OSS 访问密钥 ID     | 是   | 所有环境 |
| `OSS_SECRET_KEY` | String | -                 | OSS 访问密钥 Secret | 是   | 所有环境 |
| `OSS_BASE_URL`   | String | -                 | OSS 基础访问 URL    | 否   | 所有环境 |
| `OSS_PREFIX`     | String | `upload/`         | OSS 文件前缀        | 否   | 所有环境 |

### 腾讯云 COS

| 环境变量名       | 类型   | 默认值        | 说明             | 必需 | 环境要求 |
| ---------------- | ------ | ------------- | ---------------- | ---- | -------- |
| `COS_REGION`     | String | `ap-shanghai` | COS 区域         | 是   | 所有环境 |
| `COS_BUCKET`     | String | -             | COS 存储桶名称   | 是   | 所有环境 |
| `COS_SECRET_ID`  | String | -             | COS Secret ID    | 是   | 所有环境 |
| `COS_SECRET_KEY` | String | -             | COS Secret Key   | 是   | 所有环境 |
| `COS_BASE_URL`   | String | -             | COS 基础访问 URL | 否   | 所有环境 |

### 短信服务

| 环境变量名                  | 类型   | 默认值    | 说明                                 | 必需 | 环境要求 |
| --------------------------- | ------ | --------- | ------------------------------------ | ---- | -------- |
| `SMS_PROVIDER`              | String | `alidayu` | 短信服务提供商：`alidayu`、`tencent` | 否   | 所有环境 |
| `SMS_ACCESS_KEY`            | String | -         | 短信服务访问密钥                     | 是   | 所有环境 |
| `SMS_SECRET_KEY`            | String | -         | 短信服务密钥                         | 是   | 所有环境 |
| `SMS_SIGN_NAME`             | String | -         | 短信签名                             | 是   | 所有环境 |
| `SMS_TEMPLATE_LOGIN`        | String | -         | 登录验证码模板 ID                    | 是   | 所有环境 |
| `SMS_TEMPLATE_REGISTER`     | String | -         | 注册验证码模板 ID                    | 是   | 所有环境 |
| `SMS_TEMPLATE_CHANGE_PHONE` | String | -         | 更换手机号验证码模板 ID              | 否   | 所有环境 |

### 邮件服务

| 环境变量名      | 类型    | 默认值  | 说明            | 必需 | 环境要求      |
| --------------- | ------- | ------- | --------------- | ---- | ------------- |
| `EMAIL_HOST`    | String  | -       | SMTP 服务器地址 | 是   | 所有环境      |
| `EMAIL_PORT`    | Number  | `587`   | SMTP 服务器端口 | 是   | 所有环境      |
| `EMAIL_USER`    | String  | -       | SMTP 用户名     | 是   | 所有环境      |
| `EMAIL_PASS`    | String  | -       | SMTP 密码       | 是   | 所有环境      |
| `EMAIL_FROM`    | String  | -       | 发件人邮箱      | 是   | 所有环境      |
| `EMAIL_USE_SSL` | Boolean | `false` | 是否使用 SSL    | 否   | 测试/生产环境 |

## 日志配置

| 环境变量名        | 类型   | 默认值                | 说明                                       | 必需 | 环境要求      |
| ----------------- | ------ | --------------------- | ------------------------------------------ | ---- | ------------- |
| `LOG_LEVEL`       | String | `debug`               | 日志级别：`debug`、`info`、`warn`、`error` | 否   | 所有环境      |
| `LOG_FORMAT`      | String | `combined`            | 日志格式：`combined`、`dev`、`short`       | 否   | 所有环境      |
| `LOG_OUTPUT`      | String | `console`             | 日志输出位置：`console` 或文件路径         | 否   | 测试/生产环境 |
| `LOG_MAX_SIZE`    | Number | `10485760`            | 单个日志文件最大大小（字节）               | 否   | 测试/生产环境 |
| `LOG_MAX_FILES`   | Number | `7`                   | 保留的日志文件数量                         | 否   | 测试/生产环境 |
| `LOG_DATE_FORMAT` | String | `YYYY-MM-DD HH:mm:ss` | 日志日期格式                               | 否   | 所有环境      |

## 文件上传配置

| 环境变量名             | 类型    | 默认值                                 | 说明                                    | 必需 | 环境要求 |
| ---------------------- | ------- | -------------------------------------- | --------------------------------------- | ---- | -------- |
| `UPLOAD_MAX_SIZE`      | Number  | `10485760`                             | 单个文件最大上传大小（字节，默认 10MB） | 否   | 所有环境 |
| `UPLOAD_ALLOWED_TYPES` | String  | `image/jpeg,image/png,application/pdf` | 允许上传的文件类型，逗号分隔            | 否   | 所有环境 |
| `UPLOAD_TEMP_DIR`      | String  | `./tmp`                                | 临时文件存储目录                        | 否   | 所有环境 |
| `UPLOAD_PATH`          | String  | `./uploads`                            | 本地文件存储路径（不使用云存储时）      | 否   | 所有环境 |
| `UPLOAD_USE_CLOUD`     | Boolean | `true`                                 | 是否使用云存储                          | 否   | 所有环境 |

## 性能配置

| 环境变量名        | 类型   | 默认值                     | 说明                            | 必需 | 环境要求      |
| ----------------- | ------ | -------------------------- | ------------------------------- | ---- | ------------- |
| `NODE_OPTIONS`    | String | `-max-old-space-size=4096` | Node.js 运行参数                | 否   | 所有环境      |
| `WORKER_COUNT`    | Number | -                          | 工作进程数量，默认为 CPU 核心数 | 否   | 测试/生产环境 |
| `CACHE_TTL`       | Number | `3600`                     | 默认缓存过期时间（秒）          | 否   | 所有环境      |
| `MAX_CONNECTIONS` | Number | `1000`                     | 最大并发连接数                  | 否   | 测试/生产环境 |

## 安全配置

| 环境变量名             | 类型    | 默认值  | 说明                     | 必需 | 环境要求      |
| ---------------------- | ------- | ------- | ------------------------ | ---- | ------------- |
| `CORS_ORIGINS`         | String  | `*`     | 允许的跨域来源，逗号分隔 | 否   | 所有环境      |
| `CSRF_PROTECTION`      | Boolean | `true`  | 是否启用 CSRF 保护       | 否   | 所有环境      |
| `XSS_PROTECTION`       | Boolean | `true`  | 是否启用 XSS 保护        | 否   | 所有环境      |
| `CSP_ENABLED`          | Boolean | `false` | 是否启用内容安全策略     | 否   | 测试/生产环境 |
| `CSP_DIRECTIVES`       | String  | -       | 内容安全策略指令         | 否   | 测试/生产环境 |
| `RATE_LIMIT_ENABLED`   | Boolean | `false` | 是否启用速率限制         | 否   | 测试/生产环境 |
| `RATE_LIMIT_WINDOW_MS` | Number  | `60000` | 速率限制窗口时间（毫秒） | 否   | 测试/生产环境 |
| `RATE_LIMIT_MAX`       | Number  | `100`   | 每个窗口允许的最大请求数 | 否   | 测试/生产环境 |

## 环境特定配置建议

### 开发环境

- `NODE_ENV=development`
- `LOG_LEVEL=debug`
- 数据库使用本地开发数据库
- 密钥和凭证使用测试账号
- 禁用速率限制和部分安全功能以提高开发效率

### 测试环境

- `NODE_ENV=test`
- `LOG_LEVEL=info`
- 使用独立的测试数据库
- 启用基本的安全功能
- 可以模拟生产环境的部分配置

### 生产环境

- `NODE_ENV=production`
- `LOG_LEVEL=error` 或 `warn`
- 使用高安全性的数据库连接
- 启用所有安全功能
- 使用生产环境专用的 API 密钥和凭证
- 配置适当的性能优化参数

## 环境变量配置示例

### 开发环境示例 (.env.development)

```dotenv
# 基础环境
NODE_ENV=development
PORT=3000
HOST=0.0.0.0

# 数据库
DATABASE_URL=mysql://root:password@localhost:3306/realestate_dev

# Redis
REDIS_URL=redis://localhost:6379/0

# JWT
JWT_SECRET=dev_jwt_secret_key
JWT_EXPIRES_IN=86400

# 百度地图
BAIDU_MAP_AK=dev_baidu_map_api_key

# 日志
LOG_LEVEL=debug
```

### 生产环境示例 (.env.production)

```dotenv
# 基础环境
NODE_ENV=production
PORT=3000
HOST=0.0.0.0

# 数据库
DATABASE_URL=mysql://realestate_prod:ComplexPassword123!@db.example.com:3306/realestate_prod
DATABASE_SSL=true

# Redis
REDIS_URL=redis://redis.example.com:6379/0
REDIS_PASSWORD=redis_password

# JWT
JWT_SECRET=production_jwt_secret_key_must_be_changed
JWT_EXPIRES_IN=3600

# 百度地图
BAIDU_MAP_AK=production_baidu_map_api_key

# 阿里云 OSS
OSS_REGION=oss-cn-shanghai
OSS_BUCKET=production_bucket
OSS_ACCESS_KEY=production_access_key
OSS_SECRET_KEY=production_secret_key

# 日志
LOG_LEVEL=error
LOG_OUTPUT=/var/log/realestate-system.log

# 安全
CORS_ORIGINS=https://example.com
CSRF_PROTECTION=true
RATE_LIMIT_ENABLED=true
```

## 环境变量加载优先级

系统加载环境变量的优先级如下（从高到低）：

1. 系统环境变量
2. `.env.[NODE_ENV].local` 文件（本地特定环境，不应提交到代码库）
3. `.env.[NODE_ENV]` 文件（特定环境配置）
4. `.env.local` 文件（本地通用配置，不应提交到代码库）
5. `.env` 文件（默认配置）

## 注意事项

1. **安全性**
   - 不要将包含敏感信息的环境变量文件提交到代码仓库
   - 生产环境的密钥和密码应使用密钥管理服务或环境变量注入
   - 定期轮换密钥和凭证

2. **可维护性**
   - 为所有环境变量添加注释说明
   - 使用环境变量分组管理相关配置
   - 保持配置文件结构一致

3. **最佳实践**
   - 使用 `.env.example` 文件作为配置模板
   - 在开发团队内部共享环境变量文档
   - 自动化环境变量配置流程

---

文档最后更新时间：2024-01-01
