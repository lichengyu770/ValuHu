# 房产数据管理系统 - 部署手册

## 1. 系统概述

本文档详细描述房产数据管理系统的部署流程，包括环境要求、安装步骤、配置说明、启动停止以及常见问题处理。

## 2. 环境要求

### 2.1 服务器硬件要求

| 配置项 | 最低配置  | 推荐配置   |
| :----- | :-------- | :--------- |
| CPU    | 4核       | 8核及以上  |
| 内存   | 8GB       | 16GB及以上 |
| 硬盘   | 100GB SSD | 200GB SSD  |
| 网络   | 100Mbps   | 1Gbps      |

### 2.2 软件环境要求

#### 2.2.1 后端环境

| 软件    | 版本        | 用途           |
| :------ | :---------- | :------------- |
| Node.js | v16.x/v18.x | 运行环境       |
| npm     | v8.x/v9.x   | 包管理工具     |
| MySQL   | 8.0+        | 数据库         |
| Redis   | 6.0+        | 缓存服务(可选) |

#### 2.2.2 前端环境

| 软件    | 版本        | 用途       |
| :------ | :---------- | :--------- |
| Node.js | v16.x/v18.x | 构建环境   |
| npm     | v8.x/v9.x   | 包管理工具 |
| Nginx   | 1.18+       | Web服务器  |

## 3. 部署前准备

### 3.1 数据库准备

1. 安装MySQL数据库
2. 创建数据库和用户

```sql
-- 创建数据库
CREATE DATABASE property_management DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户
CREATE USER 'property_admin'@'%' IDENTIFIED BY 'your_secure_password';

-- 授权
GRANT ALL PRIVILEGES ON property_management.* TO 'property_admin'@'%';
FLUSH PRIVILEGES;
```

3. 导入初始数据（如需要）

### 3.2 服务器配置准备

1. 开放必要端口
   - 80端口（Web访问）
   - 443端口（HTTPS访问，可选）
   - 3306端口（MySQL，建议仅内网访问）
   - 6379端口（Redis，可选，建议仅内网访问）

2. 关闭防火墙或配置规则允许上述端口访问

## 4. 后端部署

### 4.1 安装步骤

1. 进入部署目录

```bash
cd /opt/property-management/backend
```

2. 上传或拉取代码

```bash
# 从Git仓库克隆
# git clone https://your-repo-url/property-management-backend.git .

# 或者上传压缩包并解压
unzip property-management-backend.zip
```

3. 安装依赖

```bash
npm install --production
```

### 4.2 配置文件设置

复制并修改配置文件：

```bash
cp .env.example .env
```

编辑`.env`文件，配置必要参数：

```dotenv
# 服务器配置
PORT=3000
HOST=0.0.0.0

# 数据库连接
DB_HOST=localhost
DB_PORT=3306
DB_USER=property_admin
DB_PASSWORD=your_secure_password
DB_NAME=property_management

# JWT配置
JWT_SECRET=your_jwt_secret_key
JWT_EXPIRE_HOURS=24

# 文件上传配置
UPLOAD_PATH=/opt/property-management/uploads
MAX_UPLOAD_SIZE=10485760

# 日志配置
LOG_LEVEL=info
LOG_PATH=/opt/property-management/logs
```

### 4.3 启动服务

#### 4.3.1 使用PM2管理（推荐）

1. 安装PM2

```bash
npm install -g pm2
```

2. 启动服务

```bash
pm run build
pm start
# 或直接使用pm2
pm run build
pm run serve:prod
```

3. 设置开机自启

```bash
pm run pm2:save
npm run pm2:startup
```

#### 4.3.2 使用系统服务（可选）

创建systemd服务文件：

```bash
vi /etc/systemd/system/property-management-backend.service
```

内容如下：

```ini
[Unit]
Description=Property Management System Backend
After=network.target

[Service]
Type=simple
User=nodejs
WorkingDirectory=/opt/property-management/backend
ExecStart=/usr/bin/node dist/app.js
Restart=on-failure

[Install]
WantedBy=multi-user.target
```

启动服务：

```bash
systemctl daemon-reload
systemctl start property-management-backend
systemctl enable property-management-backend
```

## 5. 前端部署

### 5.1 构建前端项目

1. 进入前端目录

```bash
cd /opt/property-management/frontend
```

2. 上传或拉取代码

```bash
# 从Git仓库克隆
# git clone https://your-repo-url/property-management-frontend.git .

# 或者上传压缩包并解压
unzip property-management-frontend.zip
```

3. 安装依赖

```bash
npm install
```

4. 修改环境配置

编辑`.env.production`文件：

```dotenv
VITE_API_BASE_URL=http://your-backend-server:3000/api/v1
VITE_APP_NAME=房产数据管理系统
```

5. 构建项目

```bash
npm run build
```

### 5.2 配置Nginx

1. 安装Nginx

```bash
# CentOS/RHEL
yum install nginx -y

# Ubuntu/Debian
apt-get install nginx -y
```

2. 创建Nginx配置文件

```bash
vi /etc/nginx/conf.d/property-management.conf
```

内容如下：

```nginx
server {
    listen 80;
    server_name your-domain.com;  # 替换为您的域名或IP

    # 静态文件配置
    location / {
        root /opt/property-management/frontend/dist;
        index index.html;
        try_files $uri $uri/ /index.html;
    }

    # API代理配置
    location /api {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 文件上传路径
    location /uploads {
        alias /opt/property-management/uploads;
        expires 30d;
    }

    # 访问日志
    access_log /var/log/nginx/property-management-access.log;
    error_log /var/log/nginx/property-management-error.log;
}
```

3. 检查并重启Nginx

```bash
nginx -t
nginx -s reload
```

## 6. HTTPS配置（可选）

1. 安装Certbot

```bash
# CentOS/RHEL
yum install epel-release -y
yum install certbot python3-certbot-nginx -y

# Ubuntu/Debian
apt-get update
apt-get install certbot python3-certbot-nginx -y
```

2. 自动获取并配置SSL证书

```bash
certbot --nginx -d your-domain.com
```

3. 配置证书自动续期

```bash
certbot renew --dry-run
```

## 7. 服务管理

### 7.1 后端服务管理

使用PM2管理服务：

```bash
# 查看服务状态
pm run pm2:list

# 重启服务
npm run pm2:restart

# 停止服务
npm run pm2:stop

# 查看日志
npm run pm2:logs
```

或使用systemctl（如果配置了系统服务）：

```bash
systemctl status property-management-backend
systemctl restart property-management-backend
systemctl stop property-management-backend
```

### 7.2 前端服务管理

```bash
# 重启Nginx
nginx -s reload

# 停止Nginx
nginx -s stop

# 启动Nginx
nginx
```

## 8. 部署验证

1. 访问系统前台
   - 打开浏览器，访问 http://your-domain.com
   - 使用默认管理员账号登录（admin/admin123）

2. 验证API接口
   - 访问 http://your-domain.com/api/v1/auth/login 检查API服务

## 9. 备份与恢复

### 9.1 数据库备份

```bash
# 备份数据库
mysqldump -u property_admin -p property_management > property_management_$(date +%Y%m%d).sql

# 压缩备份文件
tar -czvf property_management_$(date +%Y%m%d).sql.tar.gz property_management_$(date +%Y%m%d).sql
```

### 9.2 数据库恢复

```bash
# 解压备份文件
tar -xzvf property_management_20230101.sql.tar.gz

# 恢复数据库
mysql -u property_admin -p property_management < property_management_20230101.sql
```

### 9.3 配置文件备份

```bash
# 备份配置文件
cp /opt/property-management/backend/.env /opt/property-management/backend/.env.bak
cp /etc/nginx/conf.d/property-management.conf /etc/nginx/conf.d/property-management.conf.bak
```

## 10. 常见问题处理

### 10.1 数据库连接失败

- 检查数据库服务是否运行
- 验证数据库配置参数是否正确
- 检查数据库用户权限

```bash
# 检查MySQL服务状态
systemctl status mysqld

# 测试数据库连接
mysql -u property_admin -p -h localhost property_management
```

### 10.2 API接口访问失败

- 检查后端服务是否运行
- 验证Nginx配置中的API代理设置
- 查看后端日志获取详细错误信息

```bash
# 检查后端服务日志
npm run pm2:logs

# 或查看系统日志
tail -f /var/log/nginx/property-management-error.log
```

### 10.3 文件上传失败

- 检查上传目录权限
- 验证文件大小是否超过限制
- 查看磁盘空间是否充足

```bash
# 检查上传目录权限
ls -la /opt/property-management/uploads

# 检查磁盘空间
df -h
```

### 10.4 性能问题

- 检查服务器资源使用情况
- 优化数据库索引
- 考虑使用Redis缓存

```bash
# 查看系统资源使用情况
top

# 检查数据库连接情况
mysqladmin -u root -p processlist
```

## 11. 安全加固建议

1. 定期更新系统和软件包
2. 使用复杂密码并定期更换
3. 配置防火墙限制访问
4. 定期审查系统日志
5. 启用HTTPS加密传输
6. 限制数据库远程访问
7. 对敏感数据进行加密存储

## 12. 升级指南

### 12.1 版本备份

在升级前，确保备份当前系统的：

- 数据库
- 配置文件
- 上传的文件数据

### 12.2 后端升级

```bash
# 停止服务
npm run pm2:stop

# 备份数据文件
cp -r uploads uploads.bak

# 更新代码
# git pull
# 或上传新代码

# 安装新依赖
npm install --production

# 数据库迁移（如需要）
npm run migrate

# 重启服务
npm run pm2:start
```

### 12.3 前端升级

```bash
# 更新代码
# git pull
# 或上传新代码

# 构建新代码
npm install
npm run build

# 重启Nginx
nginx -s reload
```

## 13. 联系方式

系统维护团队：

- 技术支持：support@property-management.com
- 紧急热线：400-123-4567
